<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Trading Dashboard - Professional Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">    <script>
        let currentSymbol = 'BTCUSDT';
        let liquidityChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Chart.js to be fully loaded
            setTimeout(() => {
                initializeCharts();
                loadAllData();
                
                // Auto-refresh every 30 seconds
                setInterval(loadAllData, 30000);
                
                console.log('üöÄ Dashboard initialized');
            }, 100);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(156, 163, 175, 0.1);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .symbol-selector {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(156, 163, 175, 0.2);
            color: #e2e8f0;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            transition: border-color 0.2s ease;
        }

        .symbol-selector:hover {
            border-color: rgba(156, 163, 175, 0.4);
        }

        .symbol-selector:focus {
            outline: none;
            border-color: #9ca3af;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(156, 163, 175, 0.1);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
        }

        .price-display {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            border-radius: 24px;
            border: 2px solid rgba(156, 163, 175, 0.2);
            position: relative;
            overflow: hidden;
        }

        .price-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #22c55e, #3b82f6, #a855f7, #ef4444);
            background-size: 400% 100%;
            animation: gradient 3s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .current-price {
            font-size: 4.5rem;
            font-weight: 900;
            color: #ffffff;
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(156, 163, 175, 0.3);
            font-family: 'Inter', monospace;
        }

        .price-change {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .price-change.positive { 
            color: #22c55e; 
        }
        .price-change.negative { 
            color: #ef4444; 
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin: 1.5rem 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid rgba(156, 163, 175, 0.1);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .indicator {
            background: rgba(51, 65, 85, 0.3);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(156, 163, 175, 0.1);
            backdrop-filter: blur(10px);
        }

        .indicator-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .signal {
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            font-weight: 700;
            text-align: center;
            margin: 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .signal.bullish {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 2px solid #22c55e;
        }

        .signal.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 2px solid #ef4444;
        }

        .signal.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 2px solid #9ca3af;
        }

        /* Enhanced Prediction Cards */
        .prediction-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .prediction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #9ca3af, #6b7280, #9ca3af);
        }

        .ai-models {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .ai-model {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(15, 23, 42, 0.4) 100%);
            border: 2px solid rgba(156, 163, 175, 0.2);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ai-model::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.1;
            transition: all 0.3s ease;
        }

        .ai-model:hover {
            transform: translateY(-5px);
            border-color: rgba(156, 163, 175, 0.5);
        }

        .ai-model.bullish { 
            border-color: #22c55e;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
        }
        .ai-model.bullish::before {
            background: radial-gradient(circle, rgba(34, 197, 94, 0.3) 0%, transparent 70%);
        }

        .ai-model.bearish { 
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
        }
        .ai-model.bearish::before {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 70%);
        }

        .ai-model.sideways { 
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
        }
        .ai-model.sideways::before {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
        }

        .model-name {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            position: relative;
        }

        .model-name::after {
            content: '';
            position: absolute;
            bottom: -0.25rem;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: currentColor;
            opacity: 0.5;
        }

        .model-prediction {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .model-confidence {
            font-size: 0.9rem;
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            background: rgba(156, 163, 175, 0.1);
            display: inline-block;
        }

        .ensemble-result {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 24px;
            padding: 2.5rem;
            text-align: center;
            margin: 2rem 0;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .ensemble-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(156, 163, 175, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .ensemble-direction {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(156, 163, 175, 0.5);
        }

        .ensemble-confidence {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: 700;
            opacity: 0.9;
        }

        .ai-btn {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            color: white;
            border: 2px solid rgba(156, 163, 175, 0.3);
            padding: 1rem 2rem;
            border-radius: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .ai-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .ai-btn:hover::before {
            left: 100%;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(156, 163, 175, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(156, 163, 175, 0.2);
            border-top: 4px solid #9ca3af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .prediction-loading {
            text-align: center;
            padding: 3rem;
        }

        .liquidity-stats {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem;
        }

        .stat-box {
            background: rgba(0,0,0,0.4); 
            padding: 1.5rem; 
            border-radius: 16px; 
            text-align: center;
            border: 1px solid rgba(156, 163, 175, 0.1);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .current-price {
                font-size: 2.5rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .ai-models {
                grid-template-columns: 1fr;
            }
            
            .liquidity-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                ü§ñ AI Trading Dashboard
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <select id="analysisTimeframe" class="symbol-selector">
                    <option value="15m">15 Min</option>
                    <option value="1h" selected>1 Stunde</option>
                    <option value="4h">4 Stunden</option>
                    <option value="1d">1 Tag</option>
                </select>
                <button onclick="getEnhancedSignals()" class="ai-btn" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); padding: 0.5rem 1.5rem;">üéØ Pro Signale</button>
                <button onclick="runCompleteAnalysis()" class="ai-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 0.5rem 1.5rem;">üìä Vollst√§ndige Analyse</button>
                <button onclick="testMLPrediction()" class="ai-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); padding: 0.5rem 1.5rem;">ü§ñ ML Test</button>
                <button onclick="toggleSystemStatus()" class="ai-btn" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); padding: 0.5rem 1.5rem;">üîß System Status</button>
                <select id="symbolSelect" class="symbol-selector" onchange="changeSymbol()">
                    <option value="BTCUSDT">Bitcoin (BTC/USDT)</option>
                    <option value="ETHUSDT">Ethereum (ETH/USDT)</option>
                    <option value="ADAUSDT">Cardano (ADA/USDT)</option>
                    <option value="DOTUSDT">Polkadot (DOT/USDT)</option>
                    <option value="LINKUSDT">Chainlink (LINK/USDT)</option>
                    <option value="BNBUSDT">Binance Coin (BNB/USDT)</option>
                    <option value="SOLUSDT">Solana (SOL/USDT)</option>
                    <option value="MATICUSDT">Polygon (MATIC/USDT)</option>
                    <option value="AVAXUSDT">Avalanche (AVAX/USDT)</option>
                    <option value="UNIUSDT">Uniswap (UNI/USDT)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- System Status Panel (Hidden by default) -->
        <div id="systemStatusPanel" class="card" style="display: none; margin-bottom: 2rem; background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%); border: 2px solid rgba(34, 197, 94, 0.3);">
            <h3 class="section-title">üîß System Performance & Monitoring</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <!-- API Stats -->
                <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="font-size: 1.1rem; color: #22c55e; margin-bottom: 1rem; font-weight: 600;">üì° API Performance</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Requests/Min: <span id="apiRequestsPerMin" style="color: #22c55e; font-weight: 600;">0</span></div>
                        <div>Rate Limit: <span id="rateLimitStatus" style="color: #22c55e; font-weight: 600;">OK</span></div>
                        <div>Reset In: <span id="resetTime" style="color: #22c55e; font-weight: 600;">--s</span></div>
                    </div>
                </div>
                
                <!-- Cache Stats -->
                <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div style="font-size: 1.1rem; color: #3b82f6; margin-bottom: 1rem; font-weight: 600;">üíæ Cache Performance</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Cache Size: <span id="cacheSize" style="color: #3b82f6; font-weight: 600;">0</span></div>
                        <div>Hit Ratio: <span id="cacheHitRatio" style="color: #3b82f6; font-weight: 600;">0%</span></div>
                        <div>Max Size: <span id="maxCacheSize" style="color: #3b82f6; font-weight: 600;">1000</span></div>
                    </div>
                </div>
                
                <!-- System Stats -->
                <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3);">
                    <div style="font-size: 1.1rem; color: #a855f7; margin-bottom: 1rem; font-weight: 600;">‚ö° System Stats</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Memory: <span id="memoryUsage" style="color: #a855f7; font-weight: 600;">-- MB</span></div>
                        <div>CPU: <span id="cpuUsage" style="color: #a855f7; font-weight: 600;">--%</span></div>
                        <div>Uptime: <span id="systemUptime" style="color: #a855f7; font-weight: 600;">--s</span></div>
                    </div>
                </div>
                
                <!-- Alert System -->
                <div style="background: rgba(245, 158, 11, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div style="font-size: 1.1rem; color: #f59e0b; margin-bottom: 1rem; font-weight: 600;">üîî Alert System</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Active Alerts: <span id="activeAlerts" style="color: #f59e0b; font-weight: 600;">0</span></div>
                        <div>Last Triggered: <span id="lastAlert" style="color: #f59e0b; font-weight: 600;">None</span></div>
                        <button onclick="addPriceAlert()" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">Add Alert</button>
                    </div>
                </div>
            </div>
            
            <!-- Performance Chart -->
            <div style="margin-top: 1.5rem; height: 200px; background: rgba(0,0,0,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                <div>üìà Real-time Performance Chart (Coming Soon)</div>
            </div>
        </div>

        <!-- Enhanced Trading Signals Panel -->
        <div id="enhancedSignalsPanel" class="card" style="display: none; margin-bottom: 2rem; background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%); border: 2px solid rgba(220, 38, 38, 0.3);">
            <h3 class="section-title">üéØ Professional Trading Signals - Multi-Timeframe Analysis</h3>
            
            <!-- Signal Summary -->
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 2rem; align-items: center; margin-bottom: 2rem;">
                <div style="text-align: center; padding: 2rem; background: rgba(0,0,0,0.4); border-radius: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;" id="signalEmoji">üìä</div>
                    <div style="font-size: 1.8rem; font-weight: 900; margin-bottom: 0.5rem;" id="signalDirection">ANALYZING...</div>
                    <div style="font-size: 1rem; color: #94a3b8;" id="signalConfidence">Confidence: --%</div>
                </div>
                
                <div style="text-align: center; color: #94a3b8;">
                    <div style="font-size: 2rem;">‚ö°</div>
                    <div style="font-size: 0.9rem;">AI Analysis</div>
                </div>
                
                <div style="text-align: center; padding: 2rem; background: rgba(0,0,0,0.4); border-radius: 20px;">
                    <div style="font-size: 1.2rem; color: #94a3b8; margin-bottom: 0.5rem;">Backtest Performance</div>
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;" id="backtestReturn">--.-%</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">Win Rate: <span id="backtestWinRate">--%</span></div>
                </div>
            </div>
            
            <!-- Signal Components -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <!-- Multi-Timeframe -->
                <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">üìà Multi-Timeframe</div>
                    <div id="mtfSignal" style="font-size: 1.1rem; font-weight: 600; color: #3b82f6;">--</div>
                    <div id="mtfConfidence" style="font-size: 0.8rem; color: #94a3b8;">--%</div>
                </div>
                
                <!-- Volume -->
                <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">üìä Volume</div>
                    <div id="volumeSignal" style="font-size: 1.1rem; font-weight: 600; color: #22c55e;">--</div>
                    <div id="volumeStrength" style="font-size: 0.8rem; color: #94a3b8;">--x</div>
                </div>
                
                <!-- Structure -->
                <div style="background: rgba(168, 85, 247, 0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3);">
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">üèóÔ∏è Structure</div>
                    <div id="structureSignal" style="font-size: 1.1rem; font-weight: 600; color: #a855f7;">--</div>
                    <div id="structureStrength" style="font-size: 0.8rem; color: #94a3b8;">--%</div>
                </div>
                
                <!-- Divergence -->
                <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">üîÑ Divergence</div>
                    <div id="divergenceSignal" style="font-size: 1.1rem; font-weight: 600; color: #f59e0b;">--</div>
                    <div id="divergenceStrength" style="font-size: 0.8rem; color: #94a3b8;">--%</div>
                </div>
            </div>
            
            <!-- Disclaimer -->
            <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è WICHTIGER HINWEIS ‚ö†Ô∏è</div>
                <div style="color: #94a3b8; font-size: 0.9rem;">Diese Signale dienen nur zur Bildung. Keine Anlageberatung! Handeln Sie auf eigene Verantwortung.</div>
            </div>
        </div>

        <!-- Price Display -->
        <div class="price-display">
            <div class="current-price" id="currentPrice">Loading...</div>
            <div class="price-change" id="priceChange">...</div>
        </div>

        <!-- Main Dashboard Grid - Full Width Liquidity Map -->
        <div class="dashboard-grid" style="grid-template-columns: 1fr;">
            <!-- Enhanced Liquidity Map -->
            <div class="card">
                <h3 class="section-title">üíß Erweiterte Liquidit√§tskarte & Market Depth</h3>
                <div class="liquidity-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Support Levels</div>
                        <div id="supportCount" style="font-size: 1.2rem; color: #22c55e; font-weight: 600;">-</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Resistance Levels</div>
                        <div id="resistanceCount" style="font-size: 1.2rem; color: #ef4444; font-weight: 600;">-</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">St√§rkste Support</div>
                        <div id="strongestSupport" style="font-size: 1.2rem; color: #22c55e; font-weight: 600;">-</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">St√§rkste Resistance</div>
                        <div id="strongestResistance" style="font-size: 1.2rem; color: #ef4444; font-weight: 600;">-</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="liquidityChart"></canvas>
                </div>
                <div id="liquidityDetails" style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                    Klick "üìä Vollst√§ndige Analyse" um Liquidit√§tsdaten zu laden...
                </div>
            </div>
        </div>

        <!-- AI Predictions Section - Automatic Load -->
        <div class="prediction-card">
            <h3 class="section-title">ü§ñ Echte ML-Vorhersagen & KI-Analyse</h3>
            <div id="aiPredictionsContent">
                <div class="prediction-loading">
                    <div class="loading-spinner"></div>
                    <p>Klick "ÔøΩ Vollst√§ndige Analyse" f√ºr komplette Marktanalyse...</p>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div class="card" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(51, 65, 85, 0.7) 100%); border: 2px solid rgba(156, 163, 175, 0.3); margin-bottom: 2rem;">
            <h3 class="section-title">üìä Detaillierte Analyse</h3>
            <div id="analysisContent" style="color: #94a3b8; text-align: center; padding: 2rem;">
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üìä</div>
                <div>Klicke auf "Vollst√§ndige Analyse" um detaillierte technische Indikatoren zu sehen</div>
            </div>
        </div>

        <!-- Risk Assessment Card -->
        <div class="card" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(51, 65, 85, 0.7) 100%); border: 2px solid rgba(156, 163, 175, 0.3); margin-bottom: 2rem;">
            <h3 class="section-title">ÔøΩÔ∏è Risiko-Bewertung</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: center;">
                <div style="text-align: center;">
                    <div id="riskCircle" style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(#9ca3af 0deg 180deg, rgba(156, 163, 175, 0.2) 180deg 360deg); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: #0f172a; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <div id="riskPercentage" style="font-size: 1.5rem; font-weight: 900; color: #9ca3af;">--%</div>
                            <div style="font-size: 0.7rem; color: #94a3b8;">RISK</div>
                        </div>
                    </div>
                    <div id="riskLevel" style="background: rgba(156, 163, 175, 0.2); color: #9ca3af; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">CALCULATING...</div>
                </div>
                <div>
                    <div style="margin-bottom: 1rem;">
                        <div id="riskRecommendation" style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">Analysiere Risikofaktoren...</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.8rem;">
                        <div>
                            <div style="color: #94a3b8;">Risk Score:</div>
                            <div id="riskScore" style="color: #9ca3af; font-weight: 600;">-.--</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8;">Model Disagreement:</div>
                            <div id="modelDisagreement" style="color: #9ca3af; font-weight: 600;">-.--</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8;">Volatility:</div>
                            <div id="riskVolatility" style="color: #9ca3af; font-weight: 600;">-.--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Auto-refresh every 30 seconds
        setInterval(loadAllData, 30000);
        
        // Load system status every 10 seconds when panel is visible
        setInterval(() => {
            const panel = document.getElementById('systemStatusPanel');
            if (panel && panel.style.display !== 'none') {
                loadSystemStatus();
            }
        }, 10000);
        
        console.log('üöÄ Dashboard initialized with enhanced features');

        function initializeCharts() {
            try {
                console.log('üéØ Initializing liquidity chart...');
                console.log('üìä Chart.js available:', typeof Chart !== 'undefined');
                
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.error('‚ùå Chart.js not loaded!');
                    setTimeout(initializeCharts, 200);
                    return;
                }
                
                // Liquidity Chart only
                const liquidityCtx = document.getElementById('liquidityChart').getContext('2d');
                if (!liquidityCtx) {
                    console.error('‚ùå Canvas context not found!');
                    return;
                }
                
                // Destroy existing chart if it exists
                if (liquidityChart) {
                    liquidityChart.destroy();
                }
                
                liquidityChart = new Chart(liquidityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Loading...'],
                        datasets: [{
                            label: 'Support',
                            data: [0],
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: '#22c55e',
                            borderWidth: 1
                        }, {
                            label: 'Resistance',
                            data: [0],
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                labels: { color: '#94a3b8' }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            x: { 
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Liquidity chart initialized successfully');
            } catch (error) {
                console.error('‚ùå Chart initialization error:', error);
                // Retry after a delay
                setTimeout(initializeCharts, 500);
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadPriceDataSimple(),
                loadLiquidityData(),
                loadAnalysis()
            ]);
        }

        async function loadPriceDataSimple() {
            try {
                const response = await fetch('/api/chart-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentSymbol,
                        interval: '1h'
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Only update price display, no chart
                    const currentPrice = parseFloat(data.current_price);
                    const priceChange = parseFloat(data.price_change_percent);
                    
                    document.getElementById('currentPrice').textContent = `$${currentPrice.toLocaleString()}`;
                    
                    const priceChangeElement = document.getElementById('priceChange');
                    priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}% (24h)`;
                    priceChangeElement.className = `price-change ${priceChange >= 0 ? 'positive' : 'negative'}`;
                }
            } catch (error) {
                console.error('Error loading price data:', error);
            }
        }

        async function runCompleteAnalysis() {
            try {
                console.log('üöÄ Starting complete analysis for:', currentSymbol);
                
                // Show loading state in analysis content
                const analysisContent = document.getElementById('analysisContent');
                const aiPredictionsContent = document.getElementById('aiPredictionsContent');
                
                if (analysisContent) {
                    analysisContent.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <div class="loading-spinner" style="margin: 0 auto 1.5rem;"></div>
                            <div style="color: #94a3b8; font-size: 1.1rem;">F√ºhre vollst√§ndige Analyse durch...</div>
                            <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Bitte warten, Daten werden geladen...</div>
                        </div>
                    `;
                }

                // Show loading in AI predictions
                if (aiPredictionsContent) {
                    aiPredictionsContent.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <div class="loading-spinner" style="margin: 0 auto 1.5rem;"></div>
                            <div style="color: #94a3b8; font-size: 1.1rem;">ü§ñ Lade ML-Vorhersagen...</div>
                            <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">RandomForest & SVM Modelle arbeiten...</div>
                        </div>
                    `;
                }

                // Load all data components including AI predictions
                await Promise.all([
                    loadAnalysis(),
                    loadLiquidityData(),
                    loadAIPredictions()
                ]);
                
                console.log('‚úÖ Complete analysis finished');
                
                // Show success message briefly
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; font-weight: 600;';
                successDiv.textContent = '‚úÖ Vollst√§ndige Analyse mit ML abgeschlossen!';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error in complete analysis:', error);
                
                // Show error in analysis content
                const analysisContent = document.getElementById('analysisContent');
                if (analysisContent) {
                    analysisContent.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Fehler bei der Analyse</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${error.message || 'Unbekannter Fehler'}</div>
                            <button onclick="runCompleteAnalysis()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Erneut versuchen</button>
                        </div>
                    `;
                }
                
                alert('Fehler bei der vollst√§ndigen Analyse. Bitte versuche es erneut.');
            }
        }

        // === NEW: AI PREDICTIONS LOADER ===
        async function loadAIPredictions() {
            try {
                console.log('ü§ñ Loading AI predictions for:', currentSymbol);
                
                const response = await fetch('/api/ai-predictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: currentSymbol, 
                        timeframe: '24h' 
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    displayAIPredictions(data);
                    console.log('‚úÖ AI Predictions loaded successfully');
                } else {
                    throw new Error(data.error || 'AI Predictions failed');
                }
            } catch (error) {
                console.error('‚ùå Error loading AI predictions:', error);
                
                const content = document.getElementById('aiPredictionsContent');
                if (content) {
                    content.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ñ</div>
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">ML-Vorhersage Fehler</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${error.message}</div>
                            <button onclick="loadAIPredictions()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ ML erneut laden</button>
                        </div>
                    `;
                }
            }
        }

        // === NEW: DISPLAY AI PREDICTIONS ===
        function displayAIPredictions(data) {
            const content = document.getElementById('aiPredictionsContent');
            if (!content) return;

            const predictions = data.ai_predictions;
            const ensemble = predictions.ensemble;
            const models = predictions.individual_models;
            const targets = predictions.price_targets;
            const risk = predictions.risk_analysis;

            // Direction emoji and color
            const directionEmoji = ensemble.direction === 'BULLISH' ? 'üöÄ' : 
                                  ensemble.direction === 'BEARISH' ? 'üìâ' : '‚è∏Ô∏è';
            const directionColor = ensemble.direction === 'BULLISH' ? '#22c55e' : 
                                  ensemble.direction === 'BEARISH' ? '#ef4444' : '#f59e0b';

            content.innerHTML = `
                <!-- Ensemble Results -->
                <div class="ensemble-result" style="border-color: ${directionColor};">
                    <div class="ensemble-direction" style="color: ${directionColor};">
                        ${directionEmoji} ${ensemble.direction}
                    </div>
                    <div class="ensemble-confidence">
                        Confidence: ${ensemble.confidence}% | Agreement: ${(ensemble.model_agreement * 100).toFixed(0)}%
                    </div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">
                        ${ensemble.participating_models} ML Models | ${data.model_status.toUpperCase()} Status
                    </div>
                </div>

                <!-- Individual Models -->
                <div class="ai-models">
                    ${Object.keys(models).map(modelName => {
                        const model = models[modelName];
                        const modelEmoji = model.prediction === 'STRONG_BUY' ? 'üöÄ' : 
                                          model.prediction === 'BUY' ? 'üìà' :
                                          model.prediction === 'HOLD' ? '‚è∏Ô∏è' :
                                          model.prediction === 'SELL' ? 'üìâ' : 'üí•';
                        const modelClass = model.prediction.includes('BUY') ? 'bullish' : 
                                          model.prediction.includes('SELL') ? 'bearish' : 'sideways';
                        
                        return `
                            <div class="ai-model ${modelClass}">
                                <div class="model-name">${modelName.replace('_', ' ').toUpperCase()}</div>
                                <div class="model-prediction">${modelEmoji} ${model.prediction}</div>
                                <div class="model-confidence">${model.confidence.toFixed(1)}%</div>
                                <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                                    Signal: ${model.signal_strength}/2
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- Price Targets -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3); text-align: center;">
                        <div style="color: #22c55e; font-size: 0.9rem; margin-bottom: 0.5rem;">üéØ TARGET PRICE</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">$${targets.target_price}</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                        <div style="color: #3b82f6; font-size: 0.9rem; margin-bottom: 0.5rem;">üõ°Ô∏è SUPPORT</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">$${targets.support_level}</div>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                        <div style="color: #ef4444; font-size: 0.9rem; margin-bottom: 0.5rem;">üõë STOP LOSS</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">$${targets.stop_loss}</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3); text-align: center;">
                        <div style="color: #a855f7; font-size: 0.9rem; margin-bottom: 0.5rem;">‚öñÔ∏è RISK/REWARD</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #a855f7;">${targets.risk_reward_ratio}</div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="font-size: 2rem;">${risk.risk_emoji}</div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #e2e8f0;">Risk Level: ${risk.risk_level}</div>
                            <div style="font-size: 0.9rem; color: #94a3b8;">Score: ${risk.risk_score}/100</div>
                        </div>
                    </div>
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 1rem;">
                        ${risk.recommendation}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.8rem; color: #94a3b8;">
                        <div>Volatility: ${risk.factors.market_volatility}</div>
                        <div>Volume Risk: ${risk.factors.volume_risk}</div>
                        <div>Model Disagreement: ${risk.factors.model_disagreement}</div>
                        <div>Confidence Uncertainty: ${risk.factors.confidence_uncertainty}</div>
                    </div>
                </div>

                <!-- ML Status -->
                <div style="background: rgba(156, 163, 175, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center; border: 1px solid rgba(156, 163, 175, 0.2);">
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        ü§ñ ML Engine: ${data.is_ml_trained ? '‚úÖ TRAINED' : '‚ö†Ô∏è FALLBACK'} | 
                        Features: ${data.market_features.ml_features_used || 0} | 
                        Timestamp: ${new Date(data.prediction_timestamp).toLocaleTimeString()}
                    </div>
                </div>

                <!-- Disclaimer -->
                <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center; margin-top: 1rem;">
                    <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è WICHTIGER HINWEIS ‚ö†Ô∏è</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">ML-Vorhersagen dienen nur zur Bildung. Keine Anlageberatung! Handeln Sie auf eigene Verantwortung.</div>
                </div>
            `;
        }

        async function loadAnalysis() {
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol, interval: '1h' })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update analysis display and market features
                    displayAnalysis(data);
                    updateMarketFeatures(data);
                    console.log('‚úÖ Analysis & Market Features synchronized');
                }
            } catch (error) {
                console.error('Error loading analysis:', error);
            }
        }



        // üéØ NEW: Synchronized Market Features Update Function
        function updateMarketFeatures(data) {
            try {
                console.log('üîÑ Updating Market Features with data:', data);
                
                if (!data.indicators) {
                    console.warn('‚ö†Ô∏è No indicators in data');
                    return;
                }

                const indicators = data.indicators;
                
                // Update RSI with same exact value as in detailed analysis
                const rsiElement = document.getElementById('rsiValue');
                if (rsiElement && indicators.current_rsi_14 !== undefined) {
                    const rsi = indicators.current_rsi_14;
                    rsiElement.textContent = rsi.toFixed(2);
                    
                    // Update RSI color consistently
                    if (rsi > 70) {
                        rsiElement.style.color = '#ef4444';  // Red overbought
                    } else if (rsi < 30) {
                        rsiElement.style.color = '#22c55e';  // Green oversold
                    } else {
                        rsiElement.style.color = '#3b82f6';  // Blue neutral
                    }
                    console.log('‚úÖ RSI updated to:', rsi.toFixed(2));
                }
                
                // Update Volatility from ATR
                const volatilityElement = document.getElementById('volatilityValue');
                if (volatilityElement && indicators.current_atr !== undefined) {
                    const volatility = indicators.current_atr * 100;
                    volatilityElement.textContent = volatility.toFixed(4);
                    console.log('‚úÖ Volatility updated to:', volatility.toFixed(4));
                }
                
                // Update Trend Strength from ADX
                const trendElement = document.getElementById('trendValue');
                if (trendElement && indicators.current_adx !== undefined) {
                    const trendStrength = indicators.current_adx / 100;
                    trendElement.textContent = trendStrength.toFixed(2);
                    console.log('‚úÖ Trend updated to:', trendStrength.toFixed(2));
                }
                
                // Update Volume
                const volumeElement = document.getElementById('volumeValue');
                if (volumeElement && data.volume_24h) {
                    let volumeText = 'low';
                    try {
                        const volume = parseFloat(data.volume_24h.replace(/[B,M]/g, ''));
                        if (volume > 2) volumeText = 'high';
                        else if (volume > 1) volumeText = 'normal';
                    } catch (e) {
                        volumeText = 'unknown';
                    }
                    volumeElement.textContent = volumeText;
                    console.log('‚úÖ Volume updated to:', volumeText);
                }

            } catch (error) {
                console.error('‚ùå Error updating Market Features:', error);
            }
        }

        async function loadLiquidityData() {
            try {
                const response = await fetch('/api/liquiditymap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol })
                });

                const data = await response.json();
                console.log('üíß Liquidity data:', data);
                
                if (data.status === 'success') {
                    // Use the real API structure: liquidity_analysis.liquidity_zones
                    const zones = data.liquidity_analysis.liquidity_zones;
                    const labels = zones.map(zone => zone.price.toFixed(0));
                    const supportData = zones.map(zone => zone.zone_type === 'support' ? zone.liquidity_strength : 0);
                    const resistanceData = zones.map(zone => zone.zone_type === 'resistance' ? zone.liquidity_strength : 0);
                    const neutralData = zones.map(zone => zone.zone_type === 'neutral' ? zone.liquidity_strength : 0);

                    // Update chart
                    liquidityChart.data.labels = labels;
                    liquidityChart.data.datasets[0].data = supportData;
                    liquidityChart.data.datasets[1].data = resistanceData;
                    // Add neutral data to resistance dataset for now
                    liquidityChart.data.datasets[1].data = zones.map(zone => 
                        zone.zone_type === 'resistance' || zone.zone_type === 'neutral' ? zone.liquidity_strength : 0
                    );
                    liquidityChart.update('none');

                    // Update stats
                    const supports = zones.filter(z => z.zone_type === 'support');
                    const resistances = zones.filter(z => z.zone_type === 'resistance');
                    const neutrals = zones.filter(z => z.zone_type === 'neutral');
                    
                    document.getElementById('supportCount').textContent = supports.length;
                    document.getElementById('resistanceCount').textContent = resistances.length + neutrals.length;
                    
                    const strongestSupport = data.liquidity_analysis.strongest_support;
                    const strongestResistance = data.liquidity_analysis.strongest_resistance;
                    
                    document.getElementById('strongestSupport').textContent = strongestSupport ? `$${strongestSupport.price.toFixed(0)}` : '-';
                    document.getElementById('strongestResistance').textContent = strongestResistance ? `$${strongestResistance.price.toFixed(0)}` : '-';

                    // Update details with real data
                    const details = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <strong style="color: #22c55e;">Support Levels:</strong><br>
                                ${supports.length > 0 ? supports.slice(0, 3).map(s => 
                                    `$${s.price.toFixed(0)} (${(s.liquidity_strength * 100).toFixed(0)}%)`
                                ).join('<br>') : 'Keine Support-Levels'}
                            </div>
                            <div>
                                <strong style="color: #ef4444;">Resistance/Neutral:</strong><br>
                                ${[...resistances, ...neutrals].slice(0, 3).map(r => 
                                    `$${r.price.toFixed(0)} (${(r.liquidity_strength * 100).toFixed(0)}%)`
                                ).join('<br>')}
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #94a3b8;">
                            üí° Smart Money: ${data.smart_money_flow.institutional_bias.toUpperCase()} | 
                            Whale Activity: ${data.smart_money_flow.whale_activity.toUpperCase()}
                        </div>
                    `;
                    document.getElementById('liquidityDetails').innerHTML = details;
                }
            } catch (error) {
                console.error('Error loading liquidity data:', error);
                document.getElementById('liquidityDetails').innerHTML = '<div style="color: #ef4444;">‚ùå Fehler beim Laden der Liquidit√§tsdaten</div>';
            }
        }

        // üéØ ENHANCED: Professional Liquidity Map Update Function
        function updateLiquidityMap(data) {
            console.log('üíß Updating liquidity map with enhanced visualization:', data);
            
            if (!liquidityChart) {
                console.error('‚ùå liquidityChart not initialized! Trying to reinitialize...');
                initializeCharts();
                setTimeout(() => updateLiquidityMap(data), 500);
                return;
            }
            
            try {
                // Enhanced data validation
                if (!data.liquidity_analysis || !data.liquidity_analysis.liquidity_zones) {
                    console.error('‚ùå Invalid liquidity data structure:', data);
                    
                    document.getElementById('liquidityDetails').innerHTML = `
                        <div style="color: #f59e0b; text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
                            ‚ö†Ô∏è Liquidit√§tsdaten nicht verf√ºgbar - API-Struktur ge√§ndert
                        </div>
                    `;
                    return;
                }
                
                const zones = data.liquidity_analysis.liquidity_zones;
                console.log('üíß Processing', zones.length, 'liquidity zones');
                
                if (!zones || zones.length === 0) {
                    document.getElementById('liquidityDetails').innerHTML = `
                        <div style="color: #94a3b8; text-align: center; padding: 1.5rem;">
                            üìä Keine Liquidit√§tszonen gefunden f√ºr ${currentSymbol}
                        </div>
                    `;
                    return;
                }
                
                // Enhanced chart data preparation - sorted by price
                const sortedZones = zones.sort((a, b) => a.price - b.price);
                const labels = sortedZones.map(zone => `$${zone.price.toFixed(0)}`);
                
                // Enhanced data processing for better visualization
                const supportData = sortedZones.map(zone => 
                    zone.zone_type === 'support' ? zone.liquidity_strength * 100 : 0
                );
                const resistanceData = sortedZones.map(zone => 
                    zone.zone_type === 'resistance' ? zone.liquidity_strength * 100 : 0
                );

                // Update chart with smooth animation
                liquidityChart.data.labels = labels;
                liquidityChart.data.datasets[0].data = supportData;
                liquidityChart.data.datasets[1].data = resistanceData;
                
                liquidityChart.update('active');  // Smooth animation
                console.log('‚úÖ Enhanced chart updated successfully');

                // Enhanced statistics calculation
                const supports = sortedZones.filter(z => z.zone_type === 'support');
                const resistances = sortedZones.filter(z => z.zone_type === 'resistance');
                const neutrals = sortedZones.filter(z => z.zone_type === 'neutral');
                
                // Update stats with animations
                const updateStatWithAnimation = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.style.transition = 'all 0.3s ease';
                        element.textContent = value;
                        element.style.transform = 'scale(1.1)';
                        setTimeout(() => element.style.transform = 'scale(1)', 300);
                    }
                };
                
                updateStatWithAnimation('supportCount', supports.length);
                updateStatWithAnimation('resistanceCount', resistances.length);
                
                // Enhanced strongest levels display
                const strongestSupport = data.liquidity_analysis.strongest_support;
                const strongestResistance = data.liquidity_analysis.strongest_resistance;
                
                const supportElement = document.getElementById('strongestSupport');
                const resistanceElement = document.getElementById('strongestResistance');
                
                if (strongestSupport && supportElement) {
                    supportElement.textContent = `$${strongestSupport.price.toFixed(0)}`;
                    supportElement.style.fontWeight = '700';
                    supportElement.style.textShadow = '0 0 10px rgba(34, 197, 94, 0.5)';
                }
                
                if (strongestResistance && resistanceElement) {
                    resistanceElement.textContent = `$${strongestResistance.price.toFixed(0)}`;
                    resistanceElement.style.fontWeight = '700';
                    resistanceElement.style.textShadow = '0 0 10px rgba(239, 68, 68, 0.5)';
                }

                // üî• PROFESSIONAL: Enhanced details display with premium styling
                const details = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); padding: 1.5rem; border-radius: 16px; border: 2px solid rgba(34, 197, 94, 0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; position: relative;">
                                <div style="font-size: 1.5rem;">üõ°Ô∏è</div>
                                <div>
                                    <strong style="color: #22c55e; font-size: 1.2rem;">Support Levels</strong>
                                    <div style="color: #94a3b8; font-size: 0.9rem;">${supports.length} Zonen erkannt</div>
                                </div>
                            </div>
                            ${supports.length > 0 ? supports.slice(0, 4).map((s, i) => 
                                `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                                        <span style="color: #e2e8f0; font-weight: 600;">$${s.price.toFixed(0)}</span>
                                    </div>
                                    <div style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 700; font-size: 0.85rem;">
                                        ${(s.liquidity_strength * 100).toFixed(0)}%
                                    </div>
                                </div>`
                            ).join('') : '<div style="color: #94a3b8; font-style: italic; text-align: center; padding: 2rem;">Keine Support-Levels erkannt</div>'}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%); padding: 1.5rem; border-radius: 16px; border: 2px solid rgba(239, 68, 68, 0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; position: relative;">
                                <div style="font-size: 1.5rem;">üöß</div>
                                <div>
                                    <strong style="color: #ef4444; font-size: 1.2rem;">Resistance Levels</strong>
                                    <div style="color: #94a3b8; font-size: 0.9rem;">${resistances.length} Zonen erkannt</div>
                                </div>
                            </div>
                            ${resistances.length > 0 ? resistances.slice(0, 4).map((r, i) => 
                                `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                        <span style="color: #e2e8f0; font-weight: 600;">$${r.price.toFixed(0)}</span>
                                    </div>
                                    <div style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 700; font-size: 0.85rem;">
                                        ${(r.liquidity_strength * 100).toFixed(0)}%
                                    </div>
                                </div>`
                            ).join('') : '<div style="color: #94a3b8; font-style: italic; text-align: center; padding: 2rem;">Keine Resistance-Levels erkannt</div>'}
                        </div>
                    </div>

                    ${neutrals.length > 0 ? `
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); padding: 1rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3); margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <div style="color: #f59e0b; font-size: 1.2rem;">‚öñÔ∏è</div>
                            <strong style="color: #f59e0b; font-size: 1.1rem;">Neutrale Zonen (${neutrals.length})</strong>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${neutrals.slice(0, 4).map(n => 
                                `<span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 0.25rem 0.75rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem;">$${n.price.toFixed(0)}</span>`
                            ).join('')}
                        </div>
                    </div>` : ''}

                    ${data.smart_money_flow ? `
                    <div style="background: rgba(156, 163, 175, 0.1); padding: 1.5rem; border-radius: 12px; margin-top: 1rem; border: 1px solid rgba(156, 163, 175, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">üè¶ Smart Money</div>
                                <div style="color: #e2e8f0; font-weight: 700; text-transform: uppercase;">
                                    ${data.smart_money_flow.institutional_bias}
                                </div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">üêã Whale Activity</div>
                                <div style="color: #e2e8f0; font-weight: 700; text-transform: uppercase;">
                                    ${data.smart_money_flow.whale_activity}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                üìä Liquidit√§tsanalyse f√ºr <strong style="color: #e2e8f0;">${currentSymbol}</strong>
                            </div>
                            <div style="color: #9ca3af; font-size: 0.8rem;">
                                üïê ${new Date().toLocaleTimeString('de-DE')}
                            </div>
                        </div>
                    </div>` : ''}
                `;
                
                document.getElementById('liquidityDetails').innerHTML = details;
                console.log('‚úÖ Professional liquidity map display updated successfully');

            } catch (error) {
                console.error('‚ùå Error updating enhanced liquidity map:', error);
                document.getElementById('liquidityDetails').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        üö® Fehler beim Aktualisieren der Liquidit√§tskarte<br>
                        <small style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.5rem; display: block;">${error.message}</small>
                        <button onclick="loadLiquidityData()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Erneut versuchen
                        </button>
                    </div>
                `;
            }
        }

        async function runAiPrediction() {
            const timeframe = document.getElementById('predictionTimeframe').value;
            const content = document.getElementById('aiPredictionsContent');
            
            // Show loading (without spinning animation)
            content.innerHTML = `
                <div class="prediction-loading">
                    <div class="loading-spinner"></div>
                    <p>üß† KI-Modelle analysieren Marktdaten...<br>
                    <small>Neural Network, LSTM, Random Forest, SVM</small></p>
                </div>
            `;

            try {
                const response = await fetch('/api/ai-predictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentSymbol,
                        timeframe: timeframe
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    displayAiPredictions(data);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; color: #ef4444;">
                            ‚ùå Fehler bei KI-Vorhersage: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error running AI prediction:', error);
                content.innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        ‚ùå Netzwerkfehler bei KI-Vorhersage
                    </div>
                `;
            }
        }

        function displayAiPredictions(data) {
            const predictions = data.ai_predictions;
            const ensemble = predictions.ensemble;
            const models = predictions.individual_models;
            const targets = predictions.price_targets;
            const risk = predictions.risk_analysis;

            const content = document.getElementById('aiPredictionsContent');
            
            content.innerHTML = `
                <!-- Ensemble Result -->
                <div class="ensemble-result">
                    <div class="ensemble-direction">${getDirectionEmoji(ensemble.direction)} ${ensemble.direction}</div>
                    <div class="ensemble-confidence">Confidence: ${ensemble.confidence}%</div>
                    <div style="font-size: 0.9rem;">Model Agreement: ${(ensemble.model_agreement * 100).toFixed(1)}%</div>
                </div>

                <!-- Individual Models -->
                <div class="ai-models">
                    ${Object.entries(models).map(([modelName, model]) => `
                        <div class="ai-model ${model.direction.toLowerCase()}">
                            <div class="model-name">${getModelDisplayName(modelName)}</div>
                            <div class="model-prediction">${getDirectionEmoji(model.direction)} ${model.direction}</div>
                            <div class="model-confidence">${model.confidence}% Confidence</div>
                        </div>
                    `).join('')}
                </div>

                <!-- Price Targets -->
                <div class="price-targets">
                    <div class="price-target target">
                        <div class="target-label">üéØ Ziel</div>
                        <div class="target-price">$${targets.target_price.toLocaleString()}</div>
                    </div>
                    <div class="price-target stop">
                        <div class="target-label">üõë Stop Loss</div>
                        <div class="target-price">$${targets.stop_loss.toLocaleString()}</div>
                    </div>
                    <div class="price-target resistance">
                        <div class="target-label">‚ö° Widerstand</div>
                        <div class="target-price">$${targets.resistance_level.toLocaleString()}</div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="risk-assessment">
                    <h4 style="color: #60a5fa; margin-bottom: 1rem;">üõ°Ô∏è Risiko-Bewertung</h4>
                    <div class="risk-level ${risk.risk_level.toLowerCase()}">
                        ${getRiskEmoji(risk.risk_level)} ${risk.risk_level} RISK
                    </div>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1rem;">
                        ${risk.recommendation}
                    </p>
                    <div style="margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                        Risk Score: ${risk.risk_score} | 
                        Model Disagreement: ${risk.risk_factors.model_disagreement} | 
                        Volatility: ${risk.risk_factors.volatility}
                    </div>
                </div>

                <!-- Market Features -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px;">
                    <h4 style="color: #60a5fa; margin-bottom: 1rem;">üìä Markt-Features</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                        <div>RSI: <span style="color: #60a5fa;">${data.market_features.rsi}</span></div>
                        <div>Volatilit√§t: <span style="color: #60a5fa;">${data.market_features.volatility}</span></div>
                        <div>Trend St√§rke: <span style="color: #60a5fa;">${data.market_features.trend_strength.toFixed(2)}</span></div>
                        <div>Volume: <span style="color: #60a5fa;">${data.market_features.volume_profile}</span></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                    Vorhersage erstellt: ${new Date(data.prediction_timestamp).toLocaleString('de-DE')}
                </div>
            `;
        }

        function getDirectionEmoji(direction) {
            switch(direction.toUpperCase()) {
                case 'BULLISH': return 'üöÄ';
                case 'BEARISH': return 'üìâ';
                case 'SIDEWAYS': return '‚ÜîÔ∏è';
                default: return '‚ùì';
            }
        }

        function getRiskEmoji(riskLevel) {
            switch(riskLevel.toUpperCase()) {
                case 'LOW': return 'üü¢';
                case 'MEDIUM': return 'üü°';
                case 'HIGH': return 'üî¥';
                default: return '‚ö™';
            }
        }

        function getModelDisplayName(modelName) {
            const names = {
                'neural_network': 'üß† Neural Net',
                'lstm': 'üîÑ LSTM',
                'random_forest': 'üå≥ Random Forest',
                'svm': '‚ö° SVM'
            };
            return names[modelName] || modelName;
        }

        function displayAnalysis(data) {
            console.log('üìä Displaying analysis data:', data);
            const content = document.getElementById('analysisContent');
            
            // Defensive programming - validate data structure
            if (!data) {
                console.error('‚ùå No data provided to displayAnalysis');
                content.innerHTML = `
                    <div style="text-align: center; color: #f59e0b; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div>Keine Daten empfangen</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">
                            Pr√ºfe API-Verbindung und versuche es erneut
                        </div>
                    </div>
                `;
                return;
            }

            try {
                // Safe access to nested properties with fallbacks
                const indicators = data.indicators || {};
                const marketAnalysis = data.market_analysis || {};
                const mlPredictions = data.ml_predictions || {};
                
                // Calculate helper values
                const rsiValue = indicators.current_rsi_14 || 0;
                const atrValue = indicators.current_atr || 0;
                const adxValue = indicators.current_adx || 0;
                
                // RSI color logic
                let rsiColor = '#3b82f6';
                let rsiStatus = 'NEUTRAL';
                if (rsiValue > 70) {
                    rsiColor = '#ef4444';
                    rsiStatus = '√úBERKAUFT';
                } else if (rsiValue < 30) {
                    rsiColor = '#22c55e';
                    rsiStatus = '√úBERVERKAUFT';
                }
                
                // Volume analysis
                let volumeStatus = 'N/A';
                if (data.volume_24h) {
                    try {
                        const volume = parseFloat(data.volume_24h.replace(/[B,M]/g, ''));
                        if (volume > 2) volumeStatus = 'HOCH';
                        else if (volume > 1) volumeStatus = 'NORMAL';
                        else volumeStatus = 'NIEDRIG';
                    } catch (e) {
                        volumeStatus = 'UNBEKANNT';
                    }
                }
                
                // Trend status
                const trendStatus = adxValue > 25 ? 'STARKER TREND' : 'SCHWACHER TREND';

                // Build comprehensive analysis display with all features
                content.innerHTML = `
                    <!-- Markt-Features Section in Analysis -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #60a5fa; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìä Technische Indikatoren
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <!-- RSI Indicator -->
                            <div class="indicator">
                                <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üéØ RSI (14)
                                    <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.8rem;">${rsiStatus}</span>
                                </div>
                                <div class="indicator-value" style="color: ${rsiColor};">${rsiValue.toFixed(2)}</div>
                                <div style="font-size: 0.9rem; color: #94a3b8;">
                                    ${rsiValue > 70 ? '√úberkauft - Verkaufssignal m√∂glich' : 
                                      rsiValue < 30 ? '√úberverkauft - Kaufsignal m√∂glich' : 
                                      'Neutraler Bereich - Seitw√§rtstrend'}
                                </div>
                            </div>

                            <!-- ATR (Volatility) -->
                            <div class="indicator">
                                <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üìà Volatilit√§t (ATR)
                                </div>
                                <div class="indicator-value">${(atrValue * 100).toFixed(4)}%</div>
                                <div style="font-size: 0.9rem; color: #94a3b8;">
                                    ${atrValue > 0.02 ? 'Hohe Volatilit√§t' : 
                                      atrValue > 0.01 ? 'Mittlere Volatilit√§t' : 
                                      'Niedrige Volatilit√§t'}
                                </div>
                            </div>

                            <!-- ADX (Trend) -->
                            <div class="indicator">
                                <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üìä Trend St√§rke (ADX)
                                    <span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.8rem;">${trendStatus}</span>
                                </div>
                                <div class="indicator-value">${adxValue.toFixed(2)}</div>
                                <div style="font-size: 0.9rem; color: #94a3b8;">
                                    ${adxValue > 25 ? 'Starker Trend erkannt' : 'Schwacher Trend / Seitw√§rtsbewegung'}
                                </div>
                            </div>

                            <!-- Volume Analysis -->
                            <div class="indicator">
                                <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üìä Volume Analyse
                                    <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.8rem;">${volumeStatus}</span>
                                </div>
                                <div class="indicator-value">${data.volume_24h || 'N/A'}</div>
                                <div style="font-size: 0.9rem; color: #94a3b8;">
                                    24h Handelsvolumen
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support/Resistance Levels -->
                    ${data.support_resistance ? `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #60a5fa; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üéØ Support & Resistance Levels
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                                <div style="color: #22c55e; font-weight: 600; margin-bottom: 1rem;">üü¢ Support Levels</div>
                                ${data.support_resistance.support_levels?.slice(0, 3).map(level => 
                                    `<div style="margin-bottom: 0.5rem;">$${level.price?.toFixed(2) || 'N/A'} <span style="color: #94a3b8; font-size: 0.9rem;">(${level.strength || 'N/A'})</span></div>`
                                ).join('') || '<div style="color: #94a3b8;">Keine Support-Levels gefunden</div>'}
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                <div style="color: #ef4444; font-weight: 600; margin-bottom: 1rem;">üî¥ Resistance Levels</div>
                                ${data.support_resistance.resistance_levels?.slice(0, 3).map(level => 
                                    `<div style="margin-bottom: 0.5rem;">$${level.price?.toFixed(2) || 'N/A'} <span style="color: #94a3b8; font-size: 0.9rem;">(${level.strength || 'N/A'})</span></div>`
                                ).join('') || '<div style="color: #94a3b8;">Keine Resistance-Levels gefunden</div>'}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Market Analysis -->
                    ${marketAnalysis.market_sentiment ? `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #60a5fa; margin-bottom: 1.5rem;">üìà Markt Sentiment</h4>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="font-size: 1.3rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.5rem;">
                                ${marketAnalysis.market_sentiment.toUpperCase()}
                            </div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                Marktbewertung: ${marketAnalysis.confidence ? (marketAnalysis.confidence * 100).toFixed(0) + '%' : 'N/A'} Confidence
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Machine Learning Predictions -->
                    ${mlPredictions.prediction ? `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #60a5fa; margin-bottom: 1.5rem;">ü§ñ KI Vorhersage</h4>
                        <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3);">
                            <div style="font-size: 1.3rem; font-weight: 700; color: #a855f7; margin-bottom: 0.5rem;">
                                ${mlPredictions.prediction.toUpperCase()} (${mlPredictions.confidence ? (mlPredictions.confidence * 100).toFixed(0) + '%' : 'N/A'})
                            </div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                ${mlPredictions.reasoning || 'Basierend auf technischen Indikatoren und Marktdaten'}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Trading Empfehlung -->
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); padding: 2rem; border-radius: 16px; border: 2px solid rgba(245, 158, 11, 0.3); text-align: center;">
                        <div style="font-size: 1.4rem; color: #f59e0b; margin-bottom: 1rem; font-weight: 700;">‚ö° Trading Empfehlung</div>
                        <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 1rem;">
                            ${rsiValue > 70 ? 'üìâ VORSICHT: √úberkauft - Gewinnmitnahmen erw√§gen' :
                              rsiValue < 30 ? 'üìà CHANCE: √úberverkauft - Kaufgelegenheit pr√ºfen' :
                              adxValue > 25 ? 'üìä TREND: Starker Trend erkannt - Trend folgen' :
                              '‚öñÔ∏è NEUTRAL: Seitw√§rtsbewegung - Geduldig abwarten'}
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); font-size: 0.9rem; color: #94a3b8;">
                            ‚ö†Ô∏è <strong>Risikohinweis:</strong> Diese Analyse dient nur zur Information. Keine Anlageberatung! Handeln Sie auf eigene Verantwortung.
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #64748b;">
                        Analyse erstellt: ${new Date().toLocaleString('de-DE')} | Symbol: ${currentSymbol}
                    </div>
                `;

                // Update risk assessment if risk analysis data is available
                if (data.risk_analysis) {
                    updateRiskAssessment(data.risk_analysis);
                }

                console.log('‚úÖ Analysis display updated successfully');

            } catch (error) {
                console.error('‚ùå Error in displayAnalysis:', error);
                content.innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                        <div>Fehler beim Anzeigen der Analyse</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">
                            ${error.message || 'Unbekannter Fehler aufgetreten'}
                        </div>
                    </div>
                `;
            }
        }

        function changeSymbol() {
            currentSymbol = document.getElementById('symbolSelect').value;
            loadAllData();
            console.log('üîÑ Changed symbol to ' + currentSymbol);
        }

        // === ENHANCEMENT FUNCTIONS: System Status & Monitoring ===
        
        function toggleSystemStatus() {
            const panel = document.getElementById('systemStatusPanel');
            if (!panel) {
                console.error('‚ùå System Status Panel not found!');
                alert('System Status Panel nicht gefunden. Seite neu laden?');
                return;
            }

            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                console.log('üìä System Status Panel opened');
                
                // Show loading state immediately
                const loadingElements = [
                    'apiRequestsPerMin', 'rateLimitStatus', 'resetTime',
                    'cacheSize', 'cacheHitRatio', 'maxCacheSize',
                    'memoryUsage', 'cpuUsage', 'systemUptime'
                ];
                
                loadingElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = 'Loading...';
                        element.style.color = '#94a3b8';
                    }
                });
                
                // Load status data
                loadSystemStatus();
                
                // Show success notification
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #059669; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; font-weight: 600;';
                successDiv.textContent = 'üîß System Status aktiviert';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 2000);
                
            } else {
                panel.style.display = 'none';
                console.log('üìä System Status Panel closed');
            }
        }

        async function loadSystemStatus() {
            try {
                console.log('üîß Loading system status...');
                const response = await fetch('/api/system/performance');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update API stats
                    document.getElementById('apiRequestsPerMin').textContent = data.api_stats.requests_this_minute || '0';
                    document.getElementById('rateLimitStatus').textContent = data.api_stats.requests_this_minute > 1000 ? 'WARN' : 'OK';
                    document.getElementById('resetTime').textContent = Math.round(data.api_stats.time_to_reset || 0) + 's';
                    
                    // Update cache stats
                    document.getElementById('cacheSize').textContent = data.cache_stats.cache_size || '0';
                    document.getElementById('cacheHitRatio').textContent = (data.cache_stats.cache_hit_ratio * 100 || 0).toFixed(1) + '%';
                    document.getElementById('maxCacheSize').textContent = data.cache_stats.max_cache_size || '1000';
                    
                    // Update system stats
                    const memUsage = typeof data.system_stats.memory_usage_mb === 'number' 
                        ? data.system_stats.memory_usage_mb.toFixed(1) + ' MB'
                        : data.system_stats.memory_usage_mb;
                    document.getElementById('memoryUsage').textContent = memUsage;
                    
                    const cpuUsage = typeof data.system_stats.cpu_percent === 'number'
                        ? data.system_stats.cpu_percent.toFixed(1) + '%'
                        : data.system_stats.cpu_percent;
                    document.getElementById('cpuUsage').textContent = cpuUsage;
                    
                    const uptime = Math.round(data.system_stats.uptime_seconds || 0);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    document.getElementById('systemUptime').textContent = hours + 'h ' + minutes + 'm';
                    
                    // Color coding for rate limit status
                    const rateLimitElement = document.getElementById('rateLimitStatus');
                    if (data.api_stats.requests_this_minute > 1000) {
                        rateLimitElement.style.color = '#ef4444';
                    } else if (data.api_stats.requests_this_minute > 800) {
                        rateLimitElement.style.color = '#f59e0b';
                    } else {
                        rateLimitElement.style.color = '#22c55e';
                    }
                }
            } catch (error) {
                console.error('Error loading system status:', error);
                
                // Show detailed error information
                const errorElements = [
                    { id: 'apiRequestsPerMin', value: 'Error' },
                    { id: 'rateLimitStatus', value: 'Error' },
                    { id: 'resetTime', value: 'Error' },
                    { id: 'cacheSize', value: 'Error' },
                    { id: 'cacheHitRatio', value: 'Error' },
                    { id: 'memoryUsage', value: 'Error' },
                    { id: 'cpuUsage', value: 'Error' },
                    { id: 'systemUptime', value: 'Error' }
                ];
                
                errorElements.forEach(({ id, value }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        element.style.color = '#ef4444';
                    }
                });
                
                // Show error notification
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; font-weight: 600;';
                errorDiv.textContent = '‚ùå System Status Fehler: ' + (error.message || 'Unbekannt');
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (document.body.contains(errorDiv)) {
                        document.body.removeChild(errorDiv);
                    }
                }, 5000);
            }
        }

        async function addPriceAlert() {
            const symbol = currentSymbol;
            const targetPrice = prompt('Preis-Alert f√ºr ' + symbol + ' hinzuf√ºgen.\nZielpreis eingeben:');
            
            if (!targetPrice || isNaN(targetPrice)) {
                alert('Ung√ºltiger Preis eingegeben');
                return;
            }
            
            const alertType = confirm('Alert ausl√∂sen wenn Preis √úBER dem Zielpreis liegt?\n\nOK = √úber dem Preis\nAbbrechen = Unter dem Preis') ? 'above' : 'below';
            
            try {
                const response = await fetch('/api/alerts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        target_price: parseFloat(targetPrice),
                        alert_type: alertType,
                        message: symbol + ' ' + (alertType === 'above' ? '√ºber' : 'unter') + ' $' + targetPrice
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('‚úÖ Alert erfolgreich hinzugef√ºgt!\n' + data.message);
                    // Update alert count
                    const alertCount = parseInt(document.getElementById('activeAlerts').textContent) + 1;
                    document.getElementById('activeAlerts').textContent = alertCount;
                } else {
                    alert('‚ùå Fehler beim Hinzuf√ºgen des Alerts: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding alert:', error);
                alert('‚ùå Netzwerkfehler beim Hinzuf√ºgen des Alerts');
            }
        }

        // === ENHANCED ML TEST FUNCTION ===
        async function testMLPrediction() {
            try {
                console.log('ü§ñ Testing ML Prediction for:', currentSymbol);
                
                // Show loading state
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #8b5cf6; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; font-weight: 600; max-width: 400px;';
                loadingDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        ü§ñ Testing ML Models...
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                let detailsText = 'ü§ñ COMPLETE ML SYSTEM ANALYSIS\n';
                detailsText += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                // 1. ML Engine Status
                detailsText += 'üîß ML ENGINE STATUS:\n';
                try {
                    const statusResponse = await fetch('/api/ml/status');
                    const statusData = await statusResponse.json();
                    
                    detailsText += `‚Ä¢ Engine Status: ${statusData.is_trained ? '‚úÖ TRAINED' : '‚ö†Ô∏è FALLBACK MODE'}\n`;
                    detailsText += `‚Ä¢ Available Models: ${statusData.available_models.length} (${statusData.available_models.join(', ')})\n`;
                    detailsText += `‚Ä¢ Feature Count: ${statusData.feature_count}\n`;
                    detailsText += `‚Ä¢ Features Used: ${statusData.features.join(', ')}\n\n`;
                } catch (error) {
                    detailsText += `‚Ä¢ Status Error: ${error.message}\n\n`;
                }
                
                // 2. Market Data Test
                detailsText += 'üìä MARKET DATA ANALYSIS:\n';
                try {
                    const marketResponse = await fetch('/api/chart-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: currentSymbol, interval: '1h' })
                    });
                    const marketData = await marketResponse.json();
                    
                    if (marketData.status === 'success') {
                        detailsText += `‚Ä¢ Symbol: ${currentSymbol}\n`;
                        detailsText += `‚Ä¢ Current Price: $${marketData.current_price}\n`;
                        detailsText += `‚Ä¢ 24h Change: ${marketData.price_change_percent}%\n`;
                        detailsText += `‚Ä¢ Data Points: ${marketData.ohlc_data ? marketData.ohlc_data.length : 'N/A'}\n`;
                        detailsText += `‚Ä¢ Volume 24h: ${marketData.volume_24h || 'N/A'}\n\n`;
                    } else {
                        detailsText += `‚Ä¢ Market Data Error: ${marketData.error}\n\n`;
                    }
                } catch (error) {
                    detailsText += `‚Ä¢ Market Error: ${error.message}\n\n`;
                }
                
                // 3. ML Predictions Test
                detailsText += 'üéØ ML PREDICTIONS:\n';
                try {
                    const predResponse = await fetch('/api/ml/predict/' + currentSymbol);
                    const predData = await predResponse.json();
                    
                    if (predData.status === 'success') {
                        detailsText += `‚Ä¢ Prediction Status: ‚úÖ SUCCESS\n`;
                        detailsText += `‚Ä¢ Model Status: ${predData.is_trained ? 'TRAINED' : 'FALLBACK'}\n`;
                        detailsText += `‚Ä¢ Timestamp: ${new Date(predData.timestamp).toLocaleString()}\n\n`;
                        
                        detailsText += 'ü§ñ MODEL PREDICTIONS:\n';
                        Object.keys(predData.predictions).forEach(model => {
                            const pred = predData.predictions[model];
                            const emoji = pred.prediction === 'STRONG_BUY' ? 'ÔøΩ' : 
                                         pred.prediction === 'BUY' ? 'üìà' :
                                         pred.prediction === 'HOLD' ? '‚è∏Ô∏è' :
                                         pred.prediction === 'SELL' ? 'üìâ' : 'üí•';
                            detailsText += `‚Ä¢ ${model.toUpperCase()}: ${emoji} ${pred.prediction}\n`;
                            detailsText += `  Confidence: ${pred.confidence.toFixed(1)}%\n`;
                            detailsText += `  Signal Strength: ${pred.signal_strength}/2\n`;
                        });
                        detailsText += '\n';
                    } else {
                        detailsText += `‚Ä¢ Prediction Error: ${predData.message}\n\n`;
                    }
                } catch (error) {
                    detailsText += `‚Ä¢ Prediction Error: ${error.message}\n\n`;
                }
                
                // 4. Enhanced AI Predictions Test
                detailsText += 'üß† ENHANCED AI ANALYSIS:\n';
                try {
                    const aiResponse = await fetch('/api/ai-predictions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: currentSymbol, timeframe: '24h' })
                    });
                    const aiData = await aiResponse.json();
                    
                    if (aiData.status === 'success') {
                        detailsText += `‚Ä¢ AI Status: ‚úÖ SUCCESS\n`;
                        detailsText += `‚Ä¢ ML Engine: ${aiData.model_status}\n`;
                        detailsText += `‚Ä¢ Features Used: ${aiData.market_features.ml_features_used || 0}\n\n`;
                        
                        detailsText += 'üéØ ENSEMBLE PREDICTION:\n';
                        const ensemble = aiData.ai_predictions.ensemble;
                        const targetEmoji = ensemble.direction === 'BULLISH' ? 'üü¢' : 
                                           ensemble.direction === 'BEARISH' ? 'üî¥' : 'üü°';
                        detailsText += `‚Ä¢ Direction: ${targetEmoji} ${ensemble.direction}\n`;
                        detailsText += `‚Ä¢ Confidence: ${ensemble.confidence}%\n`;
                        detailsText += `‚Ä¢ Model Agreement: ${ensemble.model_agreement}\n`;
                        detailsText += `‚Ä¢ Participating Models: ${ensemble.participating_models}\n\n`;
                        
                        detailsText += 'üí∞ PRICE TARGETS:\n';
                        const targets = aiData.ai_predictions.price_targets;
                        detailsText += `‚Ä¢ Target Price: $${targets.target_price}\n`;
                        detailsText += `‚Ä¢ Support Level: $${targets.support_level}\n`;
                        detailsText += `‚Ä¢ Stop Loss: $${targets.stop_loss}\n`;
                        detailsText += `‚Ä¢ Risk/Reward: ${targets.risk_reward_ratio}\n\n`;
                        
                        detailsText += '‚ö†Ô∏è RISK ASSESSMENT:\n';
                        const risk = aiData.ai_predictions.risk_analysis;
                        detailsText += `‚Ä¢ Risk Level: ${risk.risk_emoji} ${risk.risk_level}\n`;
                        detailsText += `‚Ä¢ Risk Score: ${risk.risk_score}/100\n`;
                        detailsText += `‚Ä¢ Recommendation: ${risk.recommendation}\n`;
                    } else {
                        detailsText += `‚Ä¢ AI Analysis Error: ${aiData.error}\n\n`;
                    }
                } catch (error) {
                    detailsText += `‚Ä¢ AI Error: ${error.message}\n\n`;
                }
                
                // 5. Technical Analysis Summary
                detailsText += 'üìà TECHNICAL ANALYSIS:\n';
                try {
                    const techResponse = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: currentSymbol, interval: '1h' })
                    });
                    const techData = await techResponse.json();
                    
                    if (techData.status === 'success' && techData.indicators) {
                        const indicators = techData.indicators;
                        detailsText += `‚Ä¢ RSI (14): ${indicators.current_rsi_14?.toFixed(2) || 'N/A'}\n`;
                        detailsText += `‚Ä¢ MACD: ${indicators.current_macd?.toFixed(4) || 'N/A'}\n`;
                        detailsText += `‚Ä¢ ATR: ${indicators.current_atr?.toFixed(4) || 'N/A'}\n`;
                        detailsText += `‚Ä¢ ADX: ${indicators.current_adx?.toFixed(2) || 'N/A'}\n`;
                        detailsText += `‚Ä¢ Bollinger Position: ${indicators.bb_position?.toFixed(3) || 'N/A'}\n`;
                    }
                } catch (error) {
                    detailsText += `‚Ä¢ Technical Error: ${error.message}\n`;
                }
                
                detailsText += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                detailsText += '‚ö†Ô∏è This is for educational purposes only!\n';
                detailsText += '‚ö†Ô∏è Not financial advice!\n';
                
                // Update loading state
                loadingDiv.style.background = '#22c55e';
                loadingDiv.innerHTML = '‚úÖ ML Analysis Complete!';
                
                setTimeout(() => {
                    document.body.removeChild(loadingDiv);
                    
                    // Show results in a styled popup
                    const popup = document.createElement('div');
                    popup.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: #0f172a; color: #e2e8f0; padding: 2rem; border-radius: 16px;
                        border: 2px solid #334155; z-index: 10000; max-width: 600px; max-height: 80vh;
                        overflow-y: auto; font-family: monospace; white-space: pre-wrap;
                        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                    `;
                    popup.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: #8b5cf6; margin: 0;">ü§ñ ML System Analysis</h3>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">‚úï Close</button>
                        </div>
                        <div style="font-size: 0.9rem; line-height: 1.4;">${detailsText}</div>
                    `;
                    document.body.appendChild(popup);
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå ML Test error:', error);
                alert('‚ùå ML Test Failed: ' + error.message);
                
                // Remove loading div if it exists
                const loadingDiv = document.querySelector('div[style*="position: fixed"]');
                if (loadingDiv) document.body.removeChild(loadingDiv);
            }
        }

        async function checkPriceAlerts() {
            try {
                const response = await fetch('/api/alerts/check/' + currentSymbol);
                const data = await response.json();
                
                if (data.status === 'success' && data.triggered_alerts > 0) {
                    // Show triggered alerts
                    let alertMessage = 'üîî ' + data.triggered_alerts + ' Alert(s) ausgel√∂st f√ºr ' + data.symbol + '!\n\n';
                    data.alerts.forEach(alert => {
                        alertMessage += '‚Ä¢ ' + alert.message + ' (bei $' + alert.triggered_price + ')\n';
                    });
                    
                    alert(alertMessage);
                    document.getElementById('lastAlert').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error checking alerts:', error);
            }
        }

        // Auto-check alerts every 30 seconds
        setInterval(checkPriceAlerts, 30000);

        // === ENHANCED TRADING SIGNALS FUNCTIONS ===
        
        async function getEnhancedSignals() {
            const panel = document.getElementById('enhancedSignalsPanel');
            panel.style.display = 'block';
            
            // Show loading state
            document.getElementById('signalDirection').textContent = 'ANALYZING...';
            document.getElementById('signalEmoji').textContent = '‚è≥';
            document.getElementById('signalConfidence').textContent = 'Analyzing multi-timeframe data...';
            
            try {
                const response = await fetch('/api/enhanced-signals/' + currentSymbol);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayEnhancedSignals(data);
                } else {
                    showSignalError(data.message || 'Failed to fetch signals');
                }
            } catch (error) {
                console.error('Error fetching enhanced signals:', error);
                showSignalError('Network error while fetching signals');
            }
        }

        function displayEnhancedSignals(data) {
            const signal = data.signal;
            const backtest = data.historical_performance;
            const technical = signal.technical_details || {};
            
            // Update main signal display
            const signalEmojis = {
                'STRONG_BUY': 'üöÄ',
                'BUY': 'üìà',
                'WEAK_BUY': 'üìà',
                'HOLD': '‚öñÔ∏è',
                'WEAK_SELL': 'üìâ',
                'SELL': 'üìâ',
                'STRONG_SELL': 'üîª',
                'WEAK_SIGNAL': '‚ö†Ô∏è',
                'ERROR': '‚ùå'
            };
            
            const signalColors = {
                'STRONG_BUY': '#22c55e',
                'BUY': '#10b981',
                'WEAK_BUY': '#10b981',
                'HOLD': '#94a3b8',
                'WEAK_SELL': '#f59e0b',
                'SELL': '#f59e0b',
                'STRONG_SELL': '#ef4444',
                'WEAK_SIGNAL': '#f59e0b',
                'ERROR': '#ef4444'
            };
            
            document.getElementById('signalEmoji').textContent = signalEmojis[signal.signal] || '‚ùì';
            document.getElementById('signalDirection').textContent = signal.signal;
            document.getElementById('signalDirection').style.color = signalColors[signal.signal] || '#94a3b8';
            document.getElementById('signalConfidence').textContent = 'Confidence: ' + signal.confidence + '% - ' + (signal.reason || 'No reason provided');
            
            // Update technical details
            if (technical.rsi) {
                document.getElementById('mtfSignal').textContent = 'RSI: ' + technical.rsi.toFixed(1);
                document.getElementById('mtfConfidence').textContent = technical.rsi > 70 ? 'Overbought' : technical.rsi < 30 ? 'Oversold' : 'Neutral';
            }
            
            // Volume info
            if (technical.volume_strength) {
                document.getElementById('volumeSignal').textContent = technical.volume_strength > 1.5 ? 'HIGH' : technical.volume_strength > 1.0 ? 'NORMAL' : 'LOW';
                document.getElementById('volumeStrength').textContent = technical.volume_strength.toFixed(2) + 'x';
            } else {
                document.getElementById('volumeSignal').textContent = 'N/A';
                document.getElementById('volumeStrength').textContent = '1.0x';
            }
            
            // Market structure/trend
            if (technical.trend) {
                document.getElementById('structureSignal').textContent = technical.trend.replace('_', ' ');
                
                // Calculate MA strength
                const maStrength = technical.current_price && technical.ma_20 && technical.ma_50 ? 
                    (technical.current_price > technical.ma_20 && technical.ma_20 > technical.ma_50 ? 100 : 
                     technical.current_price < technical.ma_20 && technical.ma_20 < technical.ma_50 ? 0 : 50) : 50;
                document.getElementById('structureStrength').textContent = maStrength + '%';
            }
            
            // Divergence - Set to N/A since we don't have this data in new format
            document.getElementById('divergenceSignal').textContent = 'N/A';
            document.getElementById('divergenceStrength').textContent = '0%';
            
            // Update backtest results
            if (backtest && !backtest.error) {
                document.getElementById('backtestReturn').textContent = (backtest.total_return_pct ? backtest.total_return_pct.toFixed(1) : '0') + '%';
                document.getElementById('backtestReturn').style.color = 
                    (backtest.total_return_pct || 0) > 0 ? '#22c55e' : '#ef4444';
                document.getElementById('backtestWinRate').textContent = (backtest.win_rate ? backtest.win_rate.toFixed(0) : '0') + '%';
            } else {
                document.getElementById('backtestReturn').textContent = 'N/A';
                document.getElementById('backtestWinRate').textContent = 'N/A';
            }
            
            console.log('‚úÖ Enhanced signals displayed successfully');
        }

        function showSignalError(message) {
            document.getElementById('signalDirection').textContent = 'ERROR';
            document.getElementById('signalDirection').style.color = '#ef4444';
            document.getElementById('signalEmoji').textContent = '‚ùå';
            document.getElementById('signalConfidence').textContent = message;
            
            // Reset all components
            ['mtfSignal', 'volumeSignal', 'structureSignal', 'divergenceSignal'].forEach(id => {
                document.getElementById(id).textContent = 'ERROR';
            });
            ['mtfConfidence', 'volumeStrength', 'structureStrength', 'divergenceStrength'].forEach(id => {
                document.getElementById(id).textContent = '--';
            });
        }
    </script>
</body>
</html>
