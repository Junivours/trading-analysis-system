<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AI Trading Dashboard - Professional Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">    <script>
        let currentSymbol = 'BTCUSDT';
        let liquidityChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Chart.js to be fully loaded
            setTimeout(() => {
                initializeCharts();
                loadAllData();
                
                // Auto-refresh every 30 seconds
                setInterval(loadAllData, 30000);
                
                console.log('🚀 Dashboard initialized');
            }, 100);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(156, 163, 175, 0.1);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .symbol-selector {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(156, 163, 175, 0.2);
            color: #e2e8f0;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            transition: border-color 0.2s ease;
        }

        .symbol-selector:hover {
            border-color: rgba(156, 163, 175, 0.4);
        }

        .symbol-selector:focus {
            outline: none;
            border-color: #9ca3af;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(156, 163, 175, 0.1);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
        }

        .price-display {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            border-radius: 24px;
            border: 2px solid rgba(156, 163, 175, 0.2);
            position: relative;
            overflow: hidden;
        }

        .price-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #22c55e, #3b82f6, #a855f7, #ef4444);
            background-size: 400% 100%;
            animation: gradient 3s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .current-price {
            font-size: 4.5rem;
            font-weight: 900;
            color: #ffffff;
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(156, 163, 175, 0.3);
            font-family: 'Inter', monospace;
        }

        .price-change {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .price-change.positive { 
            color: #22c55e; 
        }
        .price-change.negative { 
            color: #ef4444; 
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin: 1.5rem 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 1rem;
            border: 1px solid rgba(156, 163, 175, 0.1);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .indicator {
            background: rgba(51, 65, 85, 0.3);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(156, 163, 175, 0.1);
            backdrop-filter: blur(10px);
        }

        .indicator-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .signal {
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            font-weight: 700;
            text-align: center;
            margin: 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .signal.bullish {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 2px solid #22c55e;
        }

        .signal.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 2px solid #ef4444;
        }

        .signal.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 2px solid #9ca3af;
        }

        /* Enhanced Prediction Cards */
        .prediction-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .prediction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #9ca3af, #6b7280, #9ca3af);
        }

        .ai-models {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .ai-model {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(15, 23, 42, 0.4) 100%);
            border: 2px solid rgba(156, 163, 175, 0.2);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ai-model::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.1;
            transition: all 0.3s ease;
        }

        .ai-model:hover {
            transform: translateY(-5px);
            border-color: rgba(156, 163, 175, 0.5);
        }

        .ai-model.bullish { 
            border-color: #22c55e;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
        }
        .ai-model.bullish::before {
            background: radial-gradient(circle, rgba(34, 197, 94, 0.3) 0%, transparent 70%);
        }

        .ai-model.bearish { 
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
        }
        .ai-model.bearish::before {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 70%);
        }

        .ai-model.sideways { 
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(15, 23, 42, 0.4) 100%);
        }
        .ai-model.sideways::before {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
        }

        .model-name {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            position: relative;
        }

        .model-name::after {
            content: '';
            position: absolute;
            bottom: -0.25rem;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: currentColor;
            opacity: 0.5;
        }

        .model-prediction {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .model-confidence {
            font-size: 0.9rem;
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            background: rgba(156, 163, 175, 0.1);
            display: inline-block;
        }

        .ensemble-result {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 24px;
            padding: 2.5rem;
            text-align: center;
            margin: 2rem 0;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .ensemble-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(156, 163, 175, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .ensemble-direction {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(156, 163, 175, 0.5);
        }

        .ensemble-confidence {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: 700;
            opacity: 0.9;
        }

        .ai-btn {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            color: white;
            border: 2px solid rgba(156, 163, 175, 0.3);
            padding: 1rem 2rem;
            border-radius: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .ai-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .ai-btn:hover::before {
            left: 100%;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(156, 163, 175, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(156, 163, 175, 0.2);
            border-top: 4px solid #9ca3af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prediction-loading {
            text-align: center;
            padding: 3rem;
        }

        .liquidity-stats {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem;
        }

        .stat-box {
            background: rgba(0,0,0,0.4); 
            padding: 1.5rem; 
            border-radius: 16px; 
            text-align: center;
            border: 1px solid rgba(156, 163, 175, 0.1);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .current-price {
                font-size: 2.5rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .ai-models {
                grid-template-columns: 1fr;
            }
            
            .liquidity-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                🤖 AI Trading Dashboard
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <select id="analysisTimeframe" class="symbol-selector">
                    <option value="15m">15 Min</option>
                    <option value="1h" selected>1 Stunde</option>
                    <option value="4h">4 Stunden</option>
                    <option value="1d">1 Tag</option>
                </select>
                <button onclick="runCompleteAnalysis()" class="ai-btn" style="background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); padding: 0.5rem 1.5rem;">📊 Vollständige Analyse</button>
                <button onclick="toggleSystemStatus()" class="ai-btn" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); padding: 0.5rem 1.5rem;">🔧 System Status</button>
                <select id="symbolSelect" class="symbol-selector" onchange="changeSymbol()">
                    <option value="BTCUSDT">Bitcoin (BTC/USDT)</option>
                    <option value="ETHUSDT">Ethereum (ETH/USDT)</option>
                    <option value="ADAUSDT">Cardano (ADA/USDT)</option>
                    <option value="DOTUSDT">Polkadot (DOT/USDT)</option>
                    <option value="LINKUSDT">Chainlink (LINK/USDT)</option>
                    <option value="BNBUSDT">Binance Coin (BNB/USDT)</option>
                    <option value="SOLUSDT">Solana (SOL/USDT)</option>
                    <option value="MATICUSDT">Polygon (MATIC/USDT)</option>
                    <option value="AVAXUSDT">Avalanche (AVAX/USDT)</option>
                    <option value="UNIUSDT">Uniswap (UNI/USDT)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- System Status Panel (Hidden by default) -->
        <div id="systemStatusPanel" class="card" style="display: none; margin-bottom: 2rem; background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%); border: 2px solid rgba(34, 197, 94, 0.3);">
            <h3 class="section-title">🔧 System Performance & Monitoring</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <!-- API Stats -->
                <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="font-size: 1.1rem; color: #22c55e; margin-bottom: 1rem; font-weight: 600;">📡 API Performance</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Requests/Min: <span id="apiRequestsPerMin" style="color: #22c55e; font-weight: 600;">0</span></div>
                        <div>Rate Limit: <span id="rateLimitStatus" style="color: #22c55e; font-weight: 600;">OK</span></div>
                        <div>Reset In: <span id="resetTime" style="color: #22c55e; font-weight: 600;">--s</span></div>
                    </div>
                </div>
                
                <!-- Cache Stats -->
                <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div style="font-size: 1.1rem; color: #3b82f6; margin-bottom: 1rem; font-weight: 600;">💾 Cache Performance</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Cache Size: <span id="cacheSize" style="color: #3b82f6; font-weight: 600;">0</span></div>
                        <div>Hit Ratio: <span id="cacheHitRatio" style="color: #3b82f6; font-weight: 600;">0%</span></div>
                        <div>Max Size: <span id="maxCacheSize" style="color: #3b82f6; font-weight: 600;">1000</span></div>
                    </div>
                </div>
                
                <!-- System Stats -->
                <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3);">
                    <div style="font-size: 1.1rem; color: #a855f7; margin-bottom: 1rem; font-weight: 600;">⚡ System Stats</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Memory: <span id="memoryUsage" style="color: #a855f7; font-weight: 600;">-- MB</span></div>
                        <div>CPU: <span id="cpuUsage" style="color: #a855f7; font-weight: 600;">--%</span></div>
                        <div>Uptime: <span id="systemUptime" style="color: #a855f7; font-weight: 600;">--s</span></div>
                    </div>
                </div>
                
                <!-- Alert System -->
                <div style="background: rgba(245, 158, 11, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div style="font-size: 1.1rem; color: #f59e0b; margin-bottom: 1rem; font-weight: 600;">🔔 Alert System</div>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <div>Active Alerts: <span id="activeAlerts" style="color: #f59e0b; font-weight: 600;">0</span></div>
                        <div>Last Triggered: <span id="lastAlert" style="color: #f59e0b; font-weight: 600;">None</span></div>
                        <button onclick="addPriceAlert()" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">Add Alert</button>
                    </div>
                </div>
            </div>
            
            <!-- Performance Chart -->
            <div style="margin-top: 1.5rem; height: 200px; background: rgba(0,0,0,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                <div>📈 Real-time Performance Chart (Coming Soon)</div>
            </div>
        </div>

        <!-- Price Display -->
        <div class="price-display">
            <div class="current-price" id="currentPrice">Loading...</div>
            <div class="price-change" id="priceChange">...</div>
        </div>

        <!-- Main Dashboard Grid - Full Width Liquidity Map -->
        <div class="dashboard-grid" style="grid-template-columns: 1fr;">
            <!-- Enhanced Liquidity Map -->
            <div class="card">
                <h3 class="section-title">💧 Erweiterte Liquiditätskarte & Market Depth</h3>
                <div class="liquidity-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Support Levels</div>
                        <div id="supportCount" style="font-size: 1.2rem; color: #22c55e; font-weight: 600;">-</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Resistance Levels</div>
                        <div id="resistanceCount" style="font-size: 1.2rem; color: #ef4444; font-weight: 600;">-</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Stärkste Support</div>
                        <div id="strongestSupport" style="font-size: 1.2rem; color: #22c55e; font-weight: 600;">-</div>
                    </div>
                    <div class="stat-box" style="background: rgba(0,0,0,0.5); padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Stärkste Resistance</div>
                        <div id="strongestResistance" style="font-size: 1.2rem; color: #ef4444; font-weight: 600;">-</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="liquidityChart"></canvas>
                </div>
                <div id="liquidityDetails" style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                    Klick "📊 Vollständige Analyse" um Liquiditätsdaten zu laden...
                </div>
            </div>
        </div>

        <!-- AI Predictions Section - Automatic Load -->
        <div class="prediction-card">
            <h3 class="section-title">🤖 KI-Vorhersagen & Vollständige Analyse</h3>
            <div id="aiPredictionsContent">
                <div class="prediction-loading">
                    <div class="loading-spinner"></div>
                    <p>Klick "� Vollständige Analyse" für komplette Marktanalyse...</p>
                </div>
            </div>
        </div>

        <!-- Market Features Section - Premium Design -->
        <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%); border: 2px solid rgba(156, 163, 175, 0.3);">
            <h3 class="section-title">🏆 Markt-Features</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <!-- RSI Card -->
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 20px; padding: 2rem; text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">RSI</div>
                    <div id="rsiValue" style="font-size: 2.5rem; font-weight: 900; color: #22c55e; margin-bottom: 0.5rem;">--.--</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; font-weight: 500;">Relative Strength Index</div>
                </div>
                
                <!-- Volatilität Card -->
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 20px; padding: 2rem; text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Volatilität</div>
                    <div id="volatilityValue" style="font-size: 2.5rem; font-weight: 900; color: #3b82f6; margin-bottom: 0.5rem;">--.--</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; font-weight: 500;">Market Volatility</div>
                </div>
                
                <!-- Trend Stärke Card -->
                <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%); border: 2px solid rgba(168, 85, 247, 0.3); border-radius: 20px; padding: 2rem; text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Trend Stärke</div>
                    <div id="trendValue" style="font-size: 2.5rem; font-weight: 900; color: #a855f7; margin-bottom: 0.5rem;">--.--</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; font-weight: 500;">Trend Strength</div>
                </div>
                
                <!-- Volume Card -->
                <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 20px; padding: 2rem; text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Volume</div>
                    <div id="volumeValue" style="font-size: 2.5rem; font-weight: 900; color: #f59e0b; margin-bottom: 0.5rem;">---</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; font-weight: 500;">Trading Volume</div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Card -->
        <div class="card" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(51, 65, 85, 0.7) 100%); border: 2px solid rgba(156, 163, 175, 0.3); margin-bottom: 2rem;">
            <h3 class="section-title">�️ Risiko-Bewertung</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: center;">
                <div style="text-align: center;">
                    <div id="riskCircle" style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(#9ca3af 0deg 180deg, rgba(156, 163, 175, 0.2) 180deg 360deg); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: #0f172a; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <div id="riskPercentage" style="font-size: 1.5rem; font-weight: 900; color: #9ca3af;">--%</div>
                            <div style="font-size: 0.7rem; color: #94a3b8;">RISK</div>
                        </div>
                    </div>
                    <div id="riskLevel" style="background: rgba(156, 163, 175, 0.2); color: #9ca3af; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">CALCULATING...</div>
                </div>
                <div>
                    <div style="margin-bottom: 1rem;">
                        <div id="riskRecommendation" style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">Analysiere Risikofaktoren...</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.8rem;">
                        <div>
                            <div style="color: #94a3b8;">Risk Score:</div>
                            <div id="riskScore" style="color: #9ca3af; font-weight: 600;">-.--</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8;">Model Disagreement:</div>
                            <div id="modelDisagreement" style="color: #9ca3af; font-weight: 600;">-.--</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8;">Volatility:</div>
                            <div id="riskVolatility" style="color: #9ca3af; font-weight: 600;">-.--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Analysis Section -->
        <div class="analysis-grid">
            <div class="card">
                <h3 class="section-title">📊 Detaillierte Marktanalyse</h3>
                <div id="analysisContent">
                    <div class="loading-spinner"></div>
                    <p style="text-align: center;">Lade Analyse...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-refresh every 30 seconds
        setInterval(loadAllData, 30000);
        
        // Load system status every 10 seconds when panel is visible
        setInterval(() => {
            const panel = document.getElementById('systemStatusPanel');
            if (panel && panel.style.display !== 'none') {
                loadSystemStatus();
            }
        }, 10000);
        
        console.log('🚀 Dashboard initialized with enhanced features');

        function initializeCharts() {
            try {
                console.log('🎯 Initializing liquidity chart...');
                console.log('📊 Chart.js available:', typeof Chart !== 'undefined');
                
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.error('❌ Chart.js not loaded!');
                    setTimeout(initializeCharts, 200);
                    return;
                }
                
                // Liquidity Chart only
                const liquidityCtx = document.getElementById('liquidityChart').getContext('2d');
                if (!liquidityCtx) {
                    console.error('❌ Canvas context not found!');
                    return;
                }
                
                // Destroy existing chart if it exists
                if (liquidityChart) {
                    liquidityChart.destroy();
                }
                
                liquidityChart = new Chart(liquidityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Loading...'],
                        datasets: [{
                            label: 'Support',
                            data: [0],
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: '#22c55e',
                            borderWidth: 1
                        }, {
                            label: 'Resistance',
                            data: [0],
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                labels: { color: '#94a3b8' }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            x: { 
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
                
                console.log('✅ Liquidity chart initialized successfully');
            } catch (error) {
                console.error('❌ Chart initialization error:', error);
                // Retry after a delay
                setTimeout(initializeCharts, 500);
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadPriceDataSimple(),
                loadLiquidityData(),
                loadAnalysis()  // Load analysis automatically to update Markt-Features
            ]);
            // Don't auto-load AI predictions - only on button click
        }

        async function loadPriceDataSimple() {
            try {
                const response = await fetch('/api/chart-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentSymbol,
                        interval: '1h'
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Only update price display, no chart
                    const currentPrice = parseFloat(data.current_price);
                    const priceChange = parseFloat(data.price_change_percent);
                    
                    document.getElementById('currentPrice').textContent = `$${currentPrice.toLocaleString()}`;
                    
                    const priceChangeElement = document.getElementById('priceChange');
                    priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}% (24h)`;
                    priceChangeElement.className = `price-change ${priceChange >= 0 ? 'positive' : 'negative'}`;
                }
            } catch (error) {
                console.error('Error loading price data:', error);
            }
        }

        async function loadAnalysis() {
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol, interval: '1h' })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // 🔥 CRITICAL: Update BOTH sections with same data to avoid RSI mismatch
                    displayAnalysis(data);
                    updateMarketFeatures(data);
                    console.log('✅ Analysis & Market Features synchronized with RSI:', data.indicators?.current_rsi_14);
                }
            } catch (error) {
                console.error('Error loading analysis:', error);
            }
        }

        // 🎯 NEW: Synchronized Market Features Update Function
        function updateMarketFeatures(data) {
            try {
                console.log('🔄 Updating Market Features with data:', data);
                
                if (!data.indicators) {
                    console.warn('⚠️ No indicators in data');
                    return;
                }

                const indicators = data.indicators;
                
                // Update RSI with same exact value as in detailed analysis
                const rsiElement = document.getElementById('rsiValue');
                if (rsiElement && indicators.current_rsi_14 !== undefined) {
                    const rsi = indicators.current_rsi_14;
                    rsiElement.textContent = rsi.toFixed(2);
                    
                    // Update RSI color consistently
                    if (rsi > 70) {
                        rsiElement.style.color = '#ef4444';  // Red overbought
                    } else if (rsi < 30) {
                        rsiElement.style.color = '#22c55e';  // Green oversold
                    } else {
                        rsiElement.style.color = '#3b82f6';  // Blue neutral
                    }
                    console.log('✅ RSI updated to:', rsi.toFixed(2));
                }
                
                // Update Volatility from ATR
                const volatilityElement = document.getElementById('volatilityValue');
                if (volatilityElement && indicators.current_atr !== undefined) {
                    const volatility = indicators.current_atr * 100;
                    volatilityElement.textContent = volatility.toFixed(4);
                    console.log('✅ Volatility updated to:', volatility.toFixed(4));
                }
                
                // Update Trend Strength from ADX
                const trendElement = document.getElementById('trendValue');
                if (trendElement && indicators.current_adx !== undefined) {
                    const trendStrength = indicators.current_adx / 100;
                    trendElement.textContent = trendStrength.toFixed(2);
                    console.log('✅ Trend updated to:', trendStrength.toFixed(2));
                }
                
                // Update Volume
                const volumeElement = document.getElementById('volumeValue');
                if (volumeElement && data.volume_24h) {
                    let volumeText = 'low';
                    try {
                        const volume = parseFloat(data.volume_24h.replace(/[B,M]/g, ''));
                        if (volume > 2) volumeText = 'high';
                        else if (volume > 1) volumeText = 'normal';
                    } catch (e) {
                        volumeText = 'unknown';
                    }
                    volumeElement.textContent = volumeText;
                    console.log('✅ Volume updated to:', volumeText);
                }

            } catch (error) {
                console.error('❌ Error updating Market Features:', error);
            }
        }

        async function loadLiquidityData() {
            try {
                const response = await fetch('/api/liquiditymap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol })
                });

                const data = await response.json();
                console.log('💧 Liquidity data:', data);
                
                if (data.status === 'success') {
                    // Use the real API structure: liquidity_analysis.liquidity_zones
                    const zones = data.liquidity_analysis.liquidity_zones;
                    const labels = zones.map(zone => zone.price.toFixed(0));
                    const supportData = zones.map(zone => zone.zone_type === 'support' ? zone.liquidity_strength : 0);
                    const resistanceData = zones.map(zone => zone.zone_type === 'resistance' ? zone.liquidity_strength : 0);
                    const neutralData = zones.map(zone => zone.zone_type === 'neutral' ? zone.liquidity_strength : 0);

                    // Update chart
                    liquidityChart.data.labels = labels;
                    liquidityChart.data.datasets[0].data = supportData;
                    liquidityChart.data.datasets[1].data = resistanceData;
                    // Add neutral data to resistance dataset for now
                    liquidityChart.data.datasets[1].data = zones.map(zone => 
                        zone.zone_type === 'resistance' || zone.zone_type === 'neutral' ? zone.liquidity_strength : 0
                    );
                    liquidityChart.update('none');

                    // Update stats
                    const supports = zones.filter(z => z.zone_type === 'support');
                    const resistances = zones.filter(z => z.zone_type === 'resistance');
                    const neutrals = zones.filter(z => z.zone_type === 'neutral');
                    
                    document.getElementById('supportCount').textContent = supports.length;
                    document.getElementById('resistanceCount').textContent = resistances.length + neutrals.length;
                    
                    const strongestSupport = data.liquidity_analysis.strongest_support;
                    const strongestResistance = data.liquidity_analysis.strongest_resistance;
                    
                    document.getElementById('strongestSupport').textContent = strongestSupport ? `$${strongestSupport.price.toFixed(0)}` : '-';
                    document.getElementById('strongestResistance').textContent = strongestResistance ? `$${strongestResistance.price.toFixed(0)}` : '-';

                    // Update details with real data
                    const details = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <strong style="color: #22c55e;">Support Levels:</strong><br>
                                ${supports.length > 0 ? supports.slice(0, 3).map(s => 
                                    `$${s.price.toFixed(0)} (${(s.liquidity_strength * 100).toFixed(0)}%)`
                                ).join('<br>') : 'Keine Support-Levels'}
                            </div>
                            <div>
                                <strong style="color: #ef4444;">Resistance/Neutral:</strong><br>
                                ${[...resistances, ...neutrals].slice(0, 3).map(r => 
                                    `$${r.price.toFixed(0)} (${(r.liquidity_strength * 100).toFixed(0)}%)`
                                ).join('<br>')}
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #94a3b8;">
                            💡 Smart Money: ${data.smart_money_flow.institutional_bias.toUpperCase()} | 
                            Whale Activity: ${data.smart_money_flow.whale_activity.toUpperCase()}
                        </div>
                    `;
                    document.getElementById('liquidityDetails').innerHTML = details;
                }
            } catch (error) {
                console.error('Error loading liquidity data:', error);
                document.getElementById('liquidityDetails').innerHTML = '<div style="color: #ef4444;">❌ Fehler beim Laden der Liquiditätsdaten</div>';
            }
        }

        // 🎯 ENHANCED: Professional Liquidity Map Update Function
        function updateLiquidityMap(data) {
            console.log('💧 Updating liquidity map with enhanced visualization:', data);
            
            if (!liquidityChart) {
                console.error('❌ liquidityChart not initialized! Trying to reinitialize...');
                initializeCharts();
                setTimeout(() => updateLiquidityMap(data), 500);
                return;
            }
            
            try {
                // Enhanced data validation
                if (!data.liquidity_analysis || !data.liquidity_analysis.liquidity_zones) {
                    console.error('❌ Invalid liquidity data structure:', data);
                    
                    document.getElementById('liquidityDetails').innerHTML = `
                        <div style="color: #f59e0b; text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
                            ⚠️ Liquiditätsdaten nicht verfügbar - API-Struktur geändert
                        </div>
                    `;
                    return;
                }
                
                const zones = data.liquidity_analysis.liquidity_zones;
                console.log('💧 Processing', zones.length, 'liquidity zones');
                
                if (!zones || zones.length === 0) {
                    document.getElementById('liquidityDetails').innerHTML = `
                        <div style="color: #94a3b8; text-align: center; padding: 1.5rem;">
                            📊 Keine Liquiditätszonen gefunden für ${currentSymbol}
                        </div>
                    `;
                    return;
                }
                
                // Enhanced chart data preparation - sorted by price
                const sortedZones = zones.sort((a, b) => a.price - b.price);
                const labels = sortedZones.map(zone => `$${zone.price.toFixed(0)}`);
                
                // Enhanced data processing for better visualization
                const supportData = sortedZones.map(zone => 
                    zone.zone_type === 'support' ? zone.liquidity_strength * 100 : 0
                );
                const resistanceData = sortedZones.map(zone => 
                    zone.zone_type === 'resistance' ? zone.liquidity_strength * 100 : 0
                );

                // Update chart with smooth animation
                liquidityChart.data.labels = labels;
                liquidityChart.data.datasets[0].data = supportData;
                liquidityChart.data.datasets[1].data = resistanceData;
                
                liquidityChart.update('active');  // Smooth animation
                console.log('✅ Enhanced chart updated successfully');

                // Enhanced statistics calculation
                const supports = sortedZones.filter(z => z.zone_type === 'support');
                const resistances = sortedZones.filter(z => z.zone_type === 'resistance');
                const neutrals = sortedZones.filter(z => z.zone_type === 'neutral');
                
                // Update stats with animations
                const updateStatWithAnimation = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.style.transition = 'all 0.3s ease';
                        element.textContent = value;
                        element.style.transform = 'scale(1.1)';
                        setTimeout(() => element.style.transform = 'scale(1)', 300);
                    }
                };
                
                updateStatWithAnimation('supportCount', supports.length);
                updateStatWithAnimation('resistanceCount', resistances.length);
                
                // Enhanced strongest levels display
                const strongestSupport = data.liquidity_analysis.strongest_support;
                const strongestResistance = data.liquidity_analysis.strongest_resistance;
                
                const supportElement = document.getElementById('strongestSupport');
                const resistanceElement = document.getElementById('strongestResistance');
                
                if (strongestSupport && supportElement) {
                    supportElement.textContent = `$${strongestSupport.price.toFixed(0)}`;
                    supportElement.style.fontWeight = '700';
                    supportElement.style.textShadow = '0 0 10px rgba(34, 197, 94, 0.5)';
                }
                
                if (strongestResistance && resistanceElement) {
                    resistanceElement.textContent = `$${strongestResistance.price.toFixed(0)}`;
                    resistanceElement.style.fontWeight = '700';
                    resistanceElement.style.textShadow = '0 0 10px rgba(239, 68, 68, 0.5)';
                }

                // 🔥 PROFESSIONAL: Enhanced details display with premium styling
                const details = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); padding: 1.5rem; border-radius: 16px; border: 2px solid rgba(34, 197, 94, 0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; position: relative;">
                                <div style="font-size: 1.5rem;">🛡️</div>
                                <div>
                                    <strong style="color: #22c55e; font-size: 1.2rem;">Support Levels</strong>
                                    <div style="color: #94a3b8; font-size: 0.9rem;">${supports.length} Zonen erkannt</div>
                                </div>
                            </div>
                            ${supports.length > 0 ? supports.slice(0, 4).map((s, i) => 
                                `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                                        <span style="color: #e2e8f0; font-weight: 600;">$${s.price.toFixed(0)}</span>
                                    </div>
                                    <div style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 700; font-size: 0.85rem;">
                                        ${(s.liquidity_strength * 100).toFixed(0)}%
                                    </div>
                                </div>`
                            ).join('') : '<div style="color: #94a3b8; font-style: italic; text-align: center; padding: 2rem;">Keine Support-Levels erkannt</div>'}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%); padding: 1.5rem; border-radius: 16px; border: 2px solid rgba(239, 68, 68, 0.3); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -50%; right: -50%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; position: relative;">
                                <div style="font-size: 1.5rem;">🚧</div>
                                <div>
                                    <strong style="color: #ef4444; font-size: 1.2rem;">Resistance Levels</strong>
                                    <div style="color: #94a3b8; font-size: 0.9rem;">${resistances.length} Zonen erkannt</div>
                                </div>
                            </div>
                            ${resistances.length > 0 ? resistances.slice(0, 4).map((r, i) => 
                                `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                        <span style="color: #e2e8f0; font-weight: 600;">$${r.price.toFixed(0)}</span>
                                    </div>
                                    <div style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 700; font-size: 0.85rem;">
                                        ${(r.liquidity_strength * 100).toFixed(0)}%
                                    </div>
                                </div>`
                            ).join('') : '<div style="color: #94a3b8; font-style: italic; text-align: center; padding: 2rem;">Keine Resistance-Levels erkannt</div>'}
                        </div>
                    </div>

                    ${neutrals.length > 0 ? `
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); padding: 1rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3); margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <div style="color: #f59e0b; font-size: 1.2rem;">⚖️</div>
                            <strong style="color: #f59e0b; font-size: 1.1rem;">Neutrale Zonen (${neutrals.length})</strong>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${neutrals.slice(0, 4).map(n => 
                                `<span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 0.25rem 0.75rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem;">$${n.price.toFixed(0)}</span>`
                            ).join('')}
                        </div>
                    </div>` : ''}

                    ${data.smart_money_flow ? `
                    <div style="background: rgba(156, 163, 175, 0.1); padding: 1.5rem; border-radius: 12px; margin-top: 1rem; border: 1px solid rgba(156, 163, 175, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">🏦 Smart Money</div>
                                <div style="color: #e2e8f0; font-weight: 700; text-transform: uppercase;">
                                    ${data.smart_money_flow.institutional_bias}
                                </div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">🐋 Whale Activity</div>
                                <div style="color: #e2e8f0; font-weight: 700; text-transform: uppercase;">
                                    ${data.smart_money_flow.whale_activity}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                📊 Liquiditätsanalyse für <strong style="color: #e2e8f0;">${currentSymbol}</strong>
                            </div>
                            <div style="color: #9ca3af; font-size: 0.8rem;">
                                🕐 ${new Date().toLocaleTimeString('de-DE')}
                            </div>
                        </div>
                    </div>` : ''}
                `;
                
                document.getElementById('liquidityDetails').innerHTML = details;
                console.log('✅ Professional liquidity map display updated successfully');

            } catch (error) {
                console.error('❌ Error updating enhanced liquidity map:', error);
                document.getElementById('liquidityDetails').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        🚨 Fehler beim Aktualisieren der Liquiditätskarte<br>
                        <small style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.5rem; display: block;">${error.message}</small>
                        <button onclick="loadLiquidityData()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            🔄 Erneut versuchen
                        </button>
                    </div>
                `;
            }
        }

        async function runAiPrediction() {
            const timeframe = document.getElementById('predictionTimeframe').value;
            const content = document.getElementById('aiPredictionsContent');
            
            // Show loading (without spinning animation)
            content.innerHTML = `
                <div class="prediction-loading">
                    <div class="loading-spinner"></div>
                    <p>🧠 KI-Modelle analysieren Marktdaten...<br>
                    <small>Neural Network, LSTM, Random Forest, SVM</small></p>
                </div>
            `;

            try {
                const response = await fetch('/api/ai-predictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentSymbol,
                        timeframe: timeframe
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    displayAiPredictions(data);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; color: #ef4444;">
                            ❌ Fehler bei KI-Vorhersage: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error running AI prediction:', error);
                content.innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        ❌ Netzwerkfehler bei KI-Vorhersage
                    </div>
                `;
            }
        }

        function displayAiPredictions(data) {
            const predictions = data.ai_predictions;
            const ensemble = predictions.ensemble;
            const models = predictions.individual_models;
            const targets = predictions.price_targets;
            const risk = predictions.risk_analysis;

            const content = document.getElementById('aiPredictionsContent');
            
            content.innerHTML = `
                <!-- Ensemble Result -->
                <div class="ensemble-result">
                    <div class="ensemble-direction">${getDirectionEmoji(ensemble.direction)} ${ensemble.direction}</div>
                    <div class="ensemble-confidence">Confidence: ${ensemble.confidence}%</div>
                    <div style="font-size: 0.9rem;">Model Agreement: ${(ensemble.model_agreement * 100).toFixed(1)}%</div>
                </div>

                <!-- Individual Models -->
                <div class="ai-models">
                    ${Object.entries(models).map(([modelName, model]) => `
                        <div class="ai-model ${model.direction.toLowerCase()}">
                            <div class="model-name">${getModelDisplayName(modelName)}</div>
                            <div class="model-prediction">${getDirectionEmoji(model.direction)} ${model.direction}</div>
                            <div class="model-confidence">${model.confidence}% Confidence</div>
                        </div>
                    `).join('')}
                </div>

                <!-- Price Targets -->
                <div class="price-targets">
                    <div class="price-target target">
                        <div class="target-label">🎯 Ziel</div>
                        <div class="target-price">$${targets.target_price.toLocaleString()}</div>
                    </div>
                    <div class="price-target stop">
                        <div class="target-label">🛑 Stop Loss</div>
                        <div class="target-price">$${targets.stop_loss.toLocaleString()}</div>
                    </div>
                    <div class="price-target resistance">
                        <div class="target-label">⚡ Widerstand</div>
                        <div class="target-price">$${targets.resistance_level.toLocaleString()}</div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="risk-assessment">
                    <h4 style="color: #60a5fa; margin-bottom: 1rem;">🛡️ Risiko-Bewertung</h4>
                    <div class="risk-level ${risk.risk_level.toLowerCase()}">
                        ${getRiskEmoji(risk.risk_level)} ${risk.risk_level} RISK
                    </div>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1rem;">
                        ${risk.recommendation}
                    </p>
                    <div style="margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                        Risk Score: ${risk.risk_score} | 
                        Model Disagreement: ${risk.risk_factors.model_disagreement} | 
                        Volatility: ${risk.risk_factors.volatility}
                    </div>
                </div>

                <!-- Market Features -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px;">
                    <h4 style="color: #60a5fa; margin-bottom: 1rem;">📊 Markt-Features</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                        <div>RSI: <span style="color: #60a5fa;">${data.market_features.rsi}</span></div>
                        <div>Volatilität: <span style="color: #60a5fa;">${data.market_features.volatility}</span></div>
                        <div>Trend Stärke: <span style="color: #60a5fa;">${data.market_features.trend_strength.toFixed(2)}</span></div>
                        <div>Volume: <span style="color: #60a5fa;">${data.market_features.volume_profile}</span></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                    Vorhersage erstellt: ${new Date(data.prediction_timestamp).toLocaleString('de-DE')}
                </div>
            `;
        }

        function getDirectionEmoji(direction) {
            switch(direction.toUpperCase()) {
                case 'BULLISH': return '🚀';
                case 'BEARISH': return '📉';
                case 'SIDEWAYS': return '↔️';
                default: return '❓';
            }
        }

        function getRiskEmoji(riskLevel) {
            switch(riskLevel.toUpperCase()) {
                case 'LOW': return '🟢';
                case 'MEDIUM': return '🟡';
                case 'HIGH': return '🔴';
                default: return '⚪';
            }
        }

        function getModelDisplayName(modelName) {
            const names = {
                'neural_network': '🧠 Neural Net',
                'lstm': '🔄 LSTM',
                'random_forest': '🌳 Random Forest',
                'svm': '⚡ SVM'
            };
            return names[modelName] || modelName;
        }

        function displayAnalysis(data) {
            console.log('📊 Displaying analysis data:', data);
            const content = document.getElementById('analysisContent');
            
            // Defensive programming - validate data structure
            if (!data) {
                console.error('❌ No data provided to displayAnalysis');
                content.innerHTML = `
                    <div style="text-align: center; color: #f59e0b; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">⚠️</div>
                        <div>Keine Daten empfangen</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">
                            Prüfe API-Verbindung und versuche es erneut
                        </div>
                    </div>
                `;
                return;
            }

            try {
                // Safe access to nested properties with fallbacks
                const indicators = data.indicators || {};
                const marketAnalysis = data.market_analysis || {};
                const mlPredictions = data.ml_predictions || {};
                
                // Update ALL Markt-Features from real API data with fallbacks
                const safeUpdateElement = (id, value, defaultValue = 'N/A') => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value !== undefined && value !== null ? value : defaultValue;
                    }
                };

                // RSI Updates with color coding
                if (indicators.current_rsi_14 !== undefined) {
                    const rsi = indicators.current_rsi_14;
                    safeUpdateElement('rsiValue', rsi.toFixed(2));
                    
                    const rsiElement = document.getElementById('rsiValue');
                    if (rsiElement) {
                        if (rsi > 70) {
                            rsiElement.style.color = '#ef4444';  // Red for overbought
                        } else if (rsi < 30) {
                            rsiElement.style.color = '#22c55e';  // Green for oversold
                        } else {
                            rsiElement.style.color = '#3b82f6';  // Blue for neutral
                        }
                    }
                }
                
                // Volatility from ATR
                if (indicators.current_atr !== undefined) {
                    const volatility = indicators.current_atr * 100;
                    safeUpdateElement('volatilityValue', volatility.toFixed(4));
                }
                
                // Trend Strength from ADX
                if (indicators.current_adx !== undefined) {
                    const trendStrength = indicators.current_adx / 100;
                    safeUpdateElement('trendValue', trendStrength.toFixed(2));
                }
                
                // Volume analysis
                if (data.volume_24h) {
                    let volumeText = 'low';
                    try {
                        const volume = parseFloat(data.volume_24h.replace(/[B,M]/g, ''));
                        if (volume > 2) volumeText = 'high';
                        else if (volume > 1) volumeText = 'normal';
                    } catch (e) {
                        volumeText = 'unknown';
                    }
                    safeUpdateElement('volumeValue', volumeText);
                }
                
                // Risk Assessment Update
                if (marketAnalysis && Object.keys(marketAnalysis).length > 0) {
                    updateRiskAssessment(marketAnalysis, indicators);
                }

                // Build robust analysis display
                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="indicator" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <div class="indicator-label" style="font-size: 0.8rem; color: #94a3b8;">RSI (14)</div>
                            <div class="indicator-value" style="font-size: 1.5rem; color: ${
                                indicators.current_rsi_14 > 70 ? '#ef4444' : 
                                indicators.current_rsi_14 < 30 ? '#22c55e' : '#9ca3af'
                            };">
                                ${indicators.current_rsi_14 ? indicators.current_rsi_14.toFixed(2) : 'N/A'}
                            </div>
                            <div class="signal" style="font-size: 0.9rem; color: #94a3b8;">
                                ${indicators.current_rsi_14 > 70 ? 'ÜBERKAUFT' : 
                                  indicators.current_rsi_14 < 30 ? 'ÜBERVERKAUFT' : 'NEUTRAL'}
                            </div>
                        </div>
                        
                        <div class="indicator" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <div class="indicator-label" style="font-size: 0.8rem; color: #94a3b8;">MACD</div>
                            <div class="indicator-value" style="font-size: 1.5rem; color: ${
                                indicators.current_macd > 0 ? '#22c55e' : '#ef4444'
                            };">
                                ${indicators.current_macd ? indicators.current_macd.toFixed(2) : 'N/A'}
                            </div>
                            <div class="signal" style="font-size: 0.9rem; color: #94a3b8;">
                                ${indicators.current_macd > 0 ? 'BULLISH' : 'BEARISH'}
                            </div>
                        </div>

                        <div class="indicator" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <div class="indicator-label" style="font-size: 0.8rem; color: #94a3b8;">ADX</div>
                            <div class="indicator-value" style="font-size: 1.5rem; color: ${
                                indicators.current_adx > 25 ? '#22c55e' : '#9ca3af'
                            };">
                                ${indicators.current_adx ? indicators.current_adx.toFixed(2) : 'N/A'}
                            </div>
                            <div class="signal" style="font-size: 0.9rem; color: #94a3b8;">
                                ${indicators.current_adx > 25 ? 'STARKER TREND' : 'SCHWACHER TREND'}
                            </div>
                        </div>

                        <div class="indicator" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <div class="indicator-label" style="font-size: 0.8rem; color: #94a3b8;">ATR</div>
                            <div class="indicator-value" style="font-size: 1.5rem; color: #9ca3af;">
                                ${indicators.current_atr ? indicators.current_atr.toFixed(4) : 'N/A'}
                            </div>
                            <div class="signal" style="font-size: 0.9rem; color: #94a3b8;">
                                VOLATILITÄT
                            </div>
                        </div>
                    </div>

                    ${marketAnalysis && Object.keys(marketAnalysis).length > 0 ? `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <h4 style="color: #9ca3af; margin-bottom: 1rem;">📊 Marktanalyse</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                            <div>Status: <span style="color: #9ca3af;">${marketAnalysis.market_state || 'N/A'}</span></div>
                            <div>Sentiment: <span style="color: #9ca3af;">${marketAnalysis.overall_sentiment || 'N/A'}</span></div>
                            <div>Empfehlung: <span style="color: #9ca3af;">${marketAnalysis.recommended_action || 'N/A'}</span></div>
                            <div>Konfidenz: <span style="color: #9ca3af;">${marketAnalysis.confidence || 'N/A'}%</span></div>
                        </div>
                    </div>` : ''}

                    ${mlPredictions && Object.keys(mlPredictions).length > 0 ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <h4 style="color: #9ca3af; margin-bottom: 1rem;">🤖 ML-Vorhersagen</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                            ${Object.entries(mlPredictions).map(([model, pred]) => `
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8rem; color: #94a3b8;">${model.replace('_', ' ').toUpperCase()}</div>
                                    <div style="color: ${pred.prediction === 'bullish' ? '#22c55e' : pred.prediction === 'bearish' ? '#ef4444' : '#9ca3af'};">
                                        ${pred.prediction || 'N/A'}
                                    </div>
                                    <div style="font-size: 0.7rem; color: #94a3b8;">${pred.confidence ? (pred.confidence * 100).toFixed(1) + '%' : 'N/A'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : `
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: center; color: #94a3b8;">
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">🤖</div>
                        <div>ML-Vorhersagen werden geladen...</div>
                    </div>`}
                `;
                
                console.log('✅ Analysis display updated successfully');
                
            } catch (error) {
                console.error('❌ Error in displayAnalysis:', error);
                content.innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">🚨</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Analysefehler</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">${error.message || 'Unbekannter Fehler'}</div>
                        <div style="font-size: 0.8rem; margin-top: 1rem; opacity: 0.6;">
                            Bitte aktualisiere die Seite oder versuche es erneut
                        </div>
                    </div>
                `;
            }
        }

        // Enhanced function to update risk assessment dynamically
        function updateRiskAssessment(marketAnalysis, indicators) {
            try {
                console.log('🎯 Updating risk assessment with:', { marketAnalysis, indicators });
                
                // Safe fallbacks for all values
                const safeMarketAnalysis = marketAnalysis || {};
                const safeIndicators = indicators || {};
                
                // Calculate risk based on market conditions with safe defaults
                let riskScore = 0.5; // Base risk
                let riskLevel = 'MEDIUM';
                let riskColor = '#f59e0b';
                let riskPercentage = 50;
                
                // Safely check RSI
                const rsi = safeIndicators.current_rsi_14;
                if (rsi !== undefined && rsi !== null) {
                    if (rsi > 80 || rsi < 20) {
                        riskScore += 0.3; // Very extreme RSI
                    } else if (rsi > 70 || rsi < 30) {
                        riskScore += 0.1; // Moderately extreme RSI
                    }
                }
                
                // Safely check ATR
                const atr = safeIndicators.current_atr;
                if (atr !== undefined && atr !== null) {
                    if (atr > 0.05) {
                        riskScore += 0.2; // High volatility
                    } else if (atr > 0.02) {
                        riskScore += 0.1; // Medium volatility
                    }
                }
                
                // Safely check confidence
                const confidence = safeMarketAnalysis.confidence;
                if (confidence !== undefined && confidence !== null && confidence < 60) {
                    riskScore += 0.1; // Low confidence = higher risk
                }
                
                // Determine final risk level
                riskScore = Math.min(1.0, Math.max(0.0, riskScore));
                riskPercentage = Math.round(riskScore * 100);
                
                if (riskScore > 0.7) {
                    riskLevel = 'HIGH RISK';
                    riskColor = '#ef4444';
                } else if (riskScore > 0.4) {
                    riskLevel = 'MEDIUM RISK';
                    riskColor = '#f59e0b';
                } else {
                    riskLevel = 'LOW RISK';
                    riskColor = '#22c55e';
                }
                
                // Safe UI updates with element existence checks
                const updateElementSafely = (id, property, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (property === 'textContent') {
                            element.textContent = value;
                        } else {
                            element.style[property] = value;
                        }
                    } else {
                        console.warn(`⚠️ Element with id '${id}' not found`);
                    }
                };
                
                // Update risk circle
                const riskCircle = document.getElementById('riskCircle');
                if (riskCircle) {
                    const degrees = Math.round(riskPercentage * 3.6);
                    riskCircle.style.background = `conic-gradient(${riskColor} 0deg ${degrees}deg, rgba(156, 163, 175, 0.2) ${degrees}deg 360deg)`;
                }
                
                updateElementSafely('riskPercentage', 'textContent', `${riskPercentage}%`);
                updateElementSafely('riskPercentage', 'color', riskColor);
                
                updateElementSafely('riskLevel', 'textContent', riskLevel);
                updateElementSafely('riskLevel', 'color', riskColor);
                
                // Parse color for background
                const colorValues = riskColor.slice(1).match(/.{2}/g);
                if (colorValues) {
                    const rgbValues = colorValues.map(x => parseInt(x, 16)).join(', ');
                    updateElementSafely('riskLevel', 'background', `rgba(${rgbValues}, 0.2)`);
                }
                
                updateElementSafely('riskScore', 'textContent', riskScore.toFixed(2));
                updateElementSafely('riskScore', 'color', riskColor);
                
                // Model disagreement calculation
                const disagreement = confidence !== undefined ? (1 - confidence / 100).toFixed(2) : 'N/A';
                updateElementSafely('modelDisagreement', 'textContent', disagreement);
                updateElementSafely('modelDisagreement', 'color', riskColor);
                
                // Volatility display
                const volatilityText = atr !== undefined ? atr.toFixed(3) : 'N/A';
                updateElementSafely('riskVolatility', 'textContent', volatilityText);
                updateElementSafely('riskVolatility', 'color', riskColor);
                
                // Update recommendation
                let recommendation = '';
                if (riskLevel === 'HIGH RISK') {
                    recommendation = 'Hohes Risiko - Kleine Positionsgrößen (0.5-1%) mit engen Stops empfohlen';
                } else if (riskLevel === 'MEDIUM RISK') {
                    recommendation = 'Moderates Risiko - Normale Positionsgrößen (1-2%) mit angemessenen Stops';
                } else {
                    recommendation = 'Niedriges Risiko - Größere Positionsgrößen (2-3%) möglich, weite Stops erlaubt';
                }
                updateElementSafely('riskRecommendation', 'textContent', recommendation);
                
                console.log('✅ Risk assessment updated successfully:', {
                    riskLevel,
                    riskPercentage,
                    riskScore: riskScore.toFixed(2)
                });
                
            } catch (error) {
                console.error('❌ Error updating risk assessment:', error);
                
                // Fallback display
                const fallbackElements = [
                    { id: 'riskPercentage', value: '50%' },
                    { id: 'riskLevel', value: 'MEDIUM' },
                    { id: 'riskScore', value: '0.50' },
                    { id: 'modelDisagreement', value: 'N/A' },
                    { id: 'riskVolatility', value: 'N/A' },
                    { id: 'riskRecommendation', value: 'Risikobewertung nicht verfügbar - Verwende moderate Positionsgrößen' }
                ];
                
                fallbackElements.forEach(({ id, value }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        element.style.color = '#f59e0b'; // Warning color
                    }
                });
            }
        }

        function changeSymbol() {
            currentSymbol = document.getElementById('symbolSelect').value;
            loadAllData();
            console.log(`🔄 Changed symbol to ${currentSymbol}`);
        }

        // New complete analysis function
        async function runCompleteAnalysis() {
            console.log('🚀 Starting complete analysis...');
            
            const selectedTimeframe = document.getElementById('analysisTimeframe').value;
            console.log(`📊 Using timeframe: ${selectedTimeframe}`);
            
            // Show loading in both sections
            document.getElementById('aiPredictionsContent').innerHTML = `
                <div class="prediction-loading">
                    <div class="loading-spinner"></div>
                    <p>🧠 Lade vollständige Marktanalyse (${selectedTimeframe})...<br>
                    <small>Technical Analysis + AI Predictions + Risk Management</small></p>
                </div>
            `;
            
            document.getElementById('analysisContent').innerHTML = `
                <div class="loading-spinner"></div>
                <p style="text-align: center;">📊 Analysiere technische Indikatoren (${selectedTimeframe})...</p>
            `;

            try {
                // Load all data in parallel for faster loading (including liquidity map)
                const [analysisResponse, aiResponse, liquidityResponse] = await Promise.all([
                    fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            symbol: currentSymbol,
                            interval: selectedTimeframe
                        })
                    }),
                    fetch('/api/ai-predictions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            symbol: currentSymbol,
                            timeframe: selectedTimeframe === '15m' ? '1h' : selectedTimeframe === '1h' ? '4h' : selectedTimeframe === '4h' ? '24h' : '7d'
                        })
                    }),
                    fetch('/api/liquiditymap', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: currentSymbol })
                    })
                ]);

                const [analysisData, aiData, liquidityData] = await Promise.all([
                    analysisResponse.json(),
                    aiResponse.json(),
                    liquidityResponse.json()
                ]);

                // Display analysis data
                if (analysisData.status === 'success') {
                    displayAnalysis(analysisData);
                } else {
                    document.getElementById('analysisContent').innerHTML = `
                        <div style="text-align: center; color: #ef4444;">
                            ❌ Fehler bei technischer Analyse: ${analysisData.error}
                        </div>
                    `;
                }

                // Display AI predictions
                if (aiData.status === 'success') {
                    displayAiPredictions(aiData);
                } else {
                    document.getElementById('aiPredictionsContent').innerHTML = `
                        <div style="text-align: center; color: #ef4444;">
                            ❌ Fehler bei KI-Vorhersage: ${aiData.error}
                        </div>
                    `;
                }

                // Display liquidity map data
                if (liquidityData.status === 'success') {
                    updateLiquidityMap(liquidityData);
                } else {
                    document.getElementById('liquidityDetails').innerHTML = `
                        <div style="color: #ef4444;">❌ Fehler beim Laden der Liquiditätsdaten</div>
                    `;
                }

                console.log('✅ Complete analysis loaded successfully (including liquidity map)');

            } catch (error) {
                console.error('Error in complete analysis:', error);
                document.getElementById('aiPredictionsContent').innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        ❌ Netzwerkfehler bei vollständiger Analyse
                    </div>
                `;
                document.getElementById('analysisContent').innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        ❌ Netzwerkfehler bei technischer Analyse
                    </div>
                `;
            }
        }

        // 🎯 MISSING FUNCTION: changeSymbol
        function changeSymbol() {
            const symbolSelect = document.getElementById('symbolSelect');
            currentSymbol = symbolSelect.value;
            console.log('🔄 Switching to symbol:', currentSymbol);
            
            // Reset displays
            document.getElementById('currentPrice').textContent = 'Loading...';
            document.getElementById('priceChange').textContent = '...';
            
            // Reload all data for new symbol
            loadAllData();
        }

        // 🎯 MISSING FUNCTION: runCompleteAnalysis
        async function runCompleteAnalysis() {
            console.log('🚀 Running complete analysis for', currentSymbol);
            const timeframe = document.getElementById('analysisTimeframe').value;
            const content = document.getElementById('aiPredictionsContent');
            
            // Show loading
            content.innerHTML = `
                <div class="prediction-loading">
                    <div class="loading-spinner"></div>
                    <p>🧠 KI-Modelle analysieren ${currentSymbol} (${timeframe})...<br>
                    <small>Neural Network, LSTM, Random Forest werden ausgeführt...</small></p>
                </div>
            `;

            try {
                // Parallel execution of all analyses
                const [aiResponse, liquidityResponse] = await Promise.all([
                    fetch('/api/ai-predictions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            symbol: currentSymbol,
                            timeframe: timeframe
                        })
                    }),
                    fetch('/api/liquiditymap', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: currentSymbol })
                    })
                ]);

                const aiData = await aiResponse.json();
                const liquidityData = await liquidityResponse.json();
                
                if (aiData.status === 'success') {
                    displayAiPredictions(aiData);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 2rem;">
                            ❌ KI-Analyse Fehler: ${aiData.message || 'Unbekannter Fehler'}
                            <br><br>
                            <button onclick="runCompleteAnalysis()" class="ai-btn">🔄 Erneut versuchen</button>
                        </div>
                    `;
                }

                // Update liquidity map if successful
                if (liquidityData.status === 'success') {
                    updateLiquidityMap(liquidityData);
                }

            } catch (error) {
                console.error('Error running complete analysis:', error);
                content.innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 2rem;">
                        🚨 Netzwerkfehler beim Laden der KI-Analyse<br>
                        <small>${error.message}</small><br><br>
                        <button onclick="runCompleteAnalysis()" class="ai-btn">🔄 Erneut versuchen</button>
                    </div>
                `;
            }
        }

        // 🎯 MISSING FUNCTION: Risk Assessment Update
        function updateRiskAssessment(marketAnalysis, indicators) {
            try {
                // Calculate risk score based on multiple factors
                let riskScore = 0;
                let factors = 0;

                // RSI risk factor
                if (indicators.current_rsi_14) {
                    const rsi = indicators.current_rsi_14;
                    if (rsi > 70 || rsi < 30) riskScore += 0.3;
                    else riskScore += 0.1;
                    factors++;
                }

                // Volatility risk factor
                if (indicators.current_atr) {
                    const atr = indicators.current_atr;
                    if (atr > 0.05) riskScore += 0.4;
                    else if (atr > 0.02) riskScore += 0.2;
                    else riskScore += 0.1;
                    factors++;
                }

                // Trend strength factor
                if (indicators.current_adx) {
                    const adx = indicators.current_adx;
                    if (adx < 20) riskScore += 0.3; // Weak trend = higher risk
                    else riskScore += 0.1;
                    factors++;
                }

                // Normalize risk score
                const finalRiskScore = factors > 0 ? (riskScore / factors) : 0.5;
                const riskPercentage = Math.round(finalRiskScore * 100);

                // Update risk circle
                const riskCircle = document.getElementById('riskCircle');
                const riskPercentageElement = document.getElementById('riskPercentage');
                const riskLevel = document.getElementById('riskLevel');

                if (riskCircle && riskPercentageElement && riskLevel) {
                    riskPercentageElement.textContent = `${riskPercentage}%`;
                    
                    // Color coding
                    let riskColor, riskText;
                    if (riskPercentage < 30) {
                        riskColor = '#22c55e';
                        riskText = 'NIEDRIG';
                    } else if (riskPercentage < 70) {
                        riskColor = '#f59e0b';
                        riskText = 'MITTEL';
                    } else {
                        riskColor = '#ef4444';
                        riskText = 'HOCH';
                    }

                    riskCircle.style.background = `conic-gradient(${riskColor} 0deg ${riskPercentage * 3.6}deg, rgba(156, 163, 175, 0.2) ${riskPercentage * 3.6}deg 360deg)`;
                    riskPercentageElement.style.color = riskColor;
                    riskLevel.textContent = riskText;
                    riskLevel.style.background = `rgba(${riskColor === '#22c55e' ? '34, 197, 94' : riskColor === '#f59e0b' ? '245, 158, 11' : '239, 68, 68'}, 0.2)`;
                    riskLevel.style.color = riskColor;
                }

                // Update detailed risk metrics
                const safeUpdate = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };

                safeUpdate('riskScore', finalRiskScore.toFixed(2));
                safeUpdate('modelDisagreement', '0.15'); // Placeholder
                safeUpdate('riskVolatility', indicators.current_atr ? (indicators.current_atr * 100).toFixed(2) + '%' : 'N/A');

            } catch (error) {
                console.error('Error updating risk assessment:', error);
            }
        }

        // === ENHANCEMENT FUNCTIONS: System Status & Monitoring ===
        
        function toggleSystemStatus() {
            const panel = document.getElementById('systemStatusPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                loadSystemStatus();  // Load immediately when opened
            } else {
                panel.style.display = 'none';
            }
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/performance');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update API stats
                    document.getElementById('apiRequestsPerMin').textContent = data.api_stats.requests_this_minute || '0';
                    document.getElementById('rateLimitStatus').textContent = data.api_stats.requests_this_minute > 1000 ? 'WARN' : 'OK';
                    document.getElementById('resetTime').textContent = Math.round(data.api_stats.time_to_reset || 0) + 's';
                    
                    // Update cache stats
                    document.getElementById('cacheSize').textContent = data.cache_stats.cache_size || '0';
                    document.getElementById('cacheHitRatio').textContent = (data.cache_stats.cache_hit_ratio * 100 || 0).toFixed(1) + '%';
                    document.getElementById('maxCacheSize').textContent = data.cache_stats.max_cache_size || '1000';
                    
                    // Update system stats
                    const memUsage = typeof data.system_stats.memory_usage_mb === 'number' 
                        ? data.system_stats.memory_usage_mb.toFixed(1) + ' MB'
                        : data.system_stats.memory_usage_mb;
                    document.getElementById('memoryUsage').textContent = memUsage;
                    
                    const cpuUsage = typeof data.system_stats.cpu_percent === 'number'
                        ? data.system_stats.cpu_percent.toFixed(1) + '%'
                        : data.system_stats.cpu_percent;
                    document.getElementById('cpuUsage').textContent = cpuUsage;
                    
                    const uptime = Math.round(data.system_stats.uptime_seconds || 0);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    document.getElementById('systemUptime').textContent = `${hours}h ${minutes}m`;
                    
                    // Color coding for rate limit status
                    const rateLimitElement = document.getElementById('rateLimitStatus');
                    if (data.api_stats.requests_this_minute > 1000) {
                        rateLimitElement.style.color = '#ef4444';
                    } else if (data.api_stats.requests_this_minute > 800) {
                        rateLimitElement.style.color = '#f59e0b';
                    } else {
                        rateLimitElement.style.color = '#22c55e';
                    }
                }
            } catch (error) {
                console.error('Error loading system status:', error);
                // Show basic fallback data
                document.getElementById('apiRequestsPerMin').textContent = 'Error';
                document.getElementById('rateLimitStatus').textContent = 'Error';
                document.getElementById('cacheSize').textContent = 'Error';
            }
        }

        async function addPriceAlert() {
            const symbol = currentSymbol;
            const targetPrice = prompt(`Preis-Alert für ${symbol} hinzufügen.\nZielpreis eingeben:`);
            
            if (!targetPrice || isNaN(targetPrice)) {
                alert('Ungültiger Preis eingegeben');
                return;
            }
            
            const alertType = confirm('Alert auslösen wenn Preis ÜBER dem Zielpreis liegt?\n\nOK = Über dem Preis\nAbbrechen = Unter dem Preis') ? 'above' : 'below';
            
            try {
                const response = await fetch('/api/alerts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        target_price: parseFloat(targetPrice),
                        alert_type: alertType,
                        message: `${symbol} ${alertType === 'above' ? 'über' : 'unter'} $${targetPrice}`
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert(`✅ Alert erfolgreich hinzugefügt!\n${data.message}`);
                    // Update alert count
                    const alertCount = parseInt(document.getElementById('activeAlerts').textContent) + 1;
                    document.getElementById('activeAlerts').textContent = alertCount;
                } else {
                    alert(`❌ Fehler beim Hinzufügen des Alerts: ${data.message}`);
                }
            } catch (error) {
                console.error('Error adding alert:', error);
                alert('❌ Netzwerkfehler beim Hinzufügen des Alerts');
            }
        }

        async function checkPriceAlerts() {
            try {
                const response = await fetch(`/api/alerts/check/${currentSymbol}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.triggered_alerts > 0) {
                    // Show triggered alerts
                    let alertMessage = `🔔 ${data.triggered_alerts} Alert(s) ausgelöst für ${data.symbol}!\n\n`;
                    data.alerts.forEach(alert => {
                        alertMessage += `• ${alert.message} (bei $${alert.triggered_price})\n`;
                    });
                    
                    alert(alertMessage);
                    document.getElementById('lastAlert').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error checking alerts:', error);
            }
        }

        // Auto-check alerts every 30 seconds
        setInterval(checkPriceAlerts, 30000);
    </script>
</body>
</html>
